name: Update FRED cache

on:
  workflow_dispatch: {}
  schedule:
    # 12:00 UTC = 20:00 Asia/Taipei
    - cron: "0 12 * * *"

permissions:
  contents: write

concurrency:
  group: fred-cache-main
  cancel-in-progress: false

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Generate cache and push (data commit + pinned manifest commit)
        env:
          FRED_API_KEY: ${{ secrets.FRED_API_KEY }}
          TIMEZONE: Asia/Taipei
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          set -euo pipefail

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          # ---- helper: update cache/manifest.json after data commit is pushed ----
          update_manifest() {
            local data_sha="$1"

            export DATA_SHA="$data_sha"

            python - <<'PY'
          import json, os
          from datetime import datetime, timezone
          from pathlib import Path

          repo = os.environ["GITHUB_REPOSITORY"]
          sha  = os.environ["DATA_SHA"]

          cache_dir = Path("cache")
          cache_dir.mkdir(parents=True, exist_ok=True)

          path = cache_dir / "manifest.json"

          # Load existing manifest if present, otherwise create a minimal one
          if path.exists():
            try:
              obj = json.loads(path.read_text(encoding="utf-8"))
            except Exception:
              obj = {}
          else:
            obj = {}

          base = f"https://raw.githubusercontent.com/{repo}/{sha}/cache"
          pinned = obj.get("pinned") if isinstance(obj.get("pinned"), dict) else {}

          pinned["latest_json"]    = f"{base}/latest.json"
          pinned["history_json"]   = f"{base}/history.json"
          pinned["latest_csv"]     = f"{base}/latest.csv"
          pinned["manifest_json"]  = f"{base}/manifest.json"

          # (可選) 如果你也有產出這些檔案，可以順便放進去（存在才寫）
          optional = {
            "history_jsonl": f"{base}/history.jsonl",
            "history_snapshot_json": f"{base}/history.snapshot.json",
            "dq_state_json": f"{base}/dq_state.json",
          }
          for k, url in optional.items():
            # 檔名規則：k 後綴去掉 _json/_jsonl
            fname = k.replace("_jsonl", ".jsonl").replace("_json", ".json")
            if (cache_dir / fname).exists():
              pinned[k] = url

          obj["generated_at_utc"] = datetime.now(timezone.utc).isoformat(timespec="seconds")
          obj["data_commit_sha"]  = sha
          obj["pinned"]           = pinned

          path.write_text(json.dumps(obj, ensure_ascii=False, separators=(",", ":")), encoding="utf-8")
          PY
          }

          # ---- main loop ----
          for attempt in 1 2 3; do
            echo "== Attempt ${attempt} =="

            # Always start from latest remote main
            git fetch origin main
            git reset --hard origin/main

            # 1) Generate cache files
            python scripts/fred_cache.py

            # 2) Data commit (all cache outputs you care about)
            git add -A cache

            if git diff --cached --quiet; then
              echo "No changes in cache outputs. Exiting."
              exit 0
            fi

            git commit -m "Update cache (latest + history)"

            # Push data commit
            if ! git push origin HEAD:main; then
              echo "Data push failed, retrying..."
              sleep $((attempt*2))
              continue
            fi

            # Capture the data commit SHA (this is now on main)
            DATA_SHA="$(git rev-parse HEAD)"
            echo "Pushed data commit: ${DATA_SHA}"

            # 3) Update manifest.json to include pinned.manifest_json etc
            update_manifest "${DATA_SHA}"

            git add cache/manifest.json

            # If manifest content didn't actually change, we're done
            if git diff --cached --quiet; then
              echo "Manifest already up-to-date. Done."
              exit 0
            fi

            git commit -m "Update cache/manifest.json (pinned urls)"

            # Push manifest commit (small retry just for this push)
            pushed=0
            for push_try in 1 2 3; do
              if git push origin HEAD:main; then
                pushed=1
                echo "Pushed manifest commit."
                break
              fi
              echo "Manifest push failed, retrying..."
              sleep $((push_try*2))
              git fetch origin main
              git reset --hard origin/main
              # Re-apply manifest update on top of latest main (which includes data commit)
              update_manifest "${DATA_SHA}"
              git add cache/manifest.json
              if ! git diff --cached --quiet; then
                git commit -m "Update cache/manifest.json (pinned urls)" || true
              fi
            done

            if [ "${pushed}" -eq 1 ]; then
              echo "All done."
              exit 0
            fi

            echo "Failed to push manifest after retries; retrying whole attempt..."
          done

          echo "Failed after retries"
          exit 1