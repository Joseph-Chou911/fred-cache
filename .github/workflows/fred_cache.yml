name: Update FRED cache

on:
  workflow_dispatch: {}
  schedule:
    # Every 6 hours at minute 7 (UTC): 00:07, 06:07, 12:07, 18:07
    # Asia/Taipei (UTC+8): 08:07, 14:07, 20:07, 02:07 (next day)
    - cron: "7 */6 * * *"

permissions:
  contents: write

concurrency:
  # IMPORTANT:
  # To make "wait instead of fail" work across workflows, ALL workflows that push to main
  # should use the same concurrency.group value.
  group: repo-writer-main
  cancel-in-progress: false

jobs:
  update:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    env:
      TIMEZONE: Asia/Taipei

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          python -m pip install requests

      - name: Configure git
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Generate + sanity + commit + push (retry-safe, no-rebase, pinned, pretty manifest)
        env:
          FRED_API_KEY: ${{ secrets.FRED_API_KEY }}
          REPO: ${{ github.repository }}
        run: |
          set -euo pipefail

          for attempt in 1 2 3; do
            echo "===== Attempt ${attempt} ====="

            git fetch origin main
            git reset --hard origin/main
            git clean -fd

            # 1) Generate cache files
            python scripts/fred_cache.py

            # 2) Sanity check BEFORE any commit/push
            python scripts/sanity_check_history.py

            # 3) Commit data files
            git add -A cache
            if git diff --cached --quiet; then
              echo "No changes in cache/. Exit."
              exit 0
            fi

            git commit -m "Update cache (latest + history)"
            DATA_SHA="$(git rev-parse HEAD)"
            export DATA_SHA
            echo "DATA_SHA=${DATA_SHA}"

            # 4) Patch manifest (pin data urls) - PRETTY
            python -c "import json,os; from pathlib import Path; data_sha=os.environ['DATA_SHA']; repo=os.environ['REPO']; p=Path('cache/manifest.json'); obj=json.loads(p.read_text(encoding='utf-8')) if p.exists() else {}; obj.setdefault('generated_at_utc',None); obj.setdefault('as_of_ts',None); obj['data_commit_sha']=data_sha; base=f'https://raw.githubusercontent.com/{repo}/{data_sha}/cache'; obj['pinned']={'latest_json':f'{base}/latest.json','history_json':f'{base}/history.json','latest_csv':f'{base}/latest.csv','manifest_json':f'https://raw.githubusercontent.com/{repo}/refs/heads/main/cache/manifest.json'}; obj.pop('manifest_commit_sha', None); obj.pop('manifest_commit_sha_v1', None); p.write_text(json.dumps(obj,ensure_ascii=False,indent=2)+\"\\n\",encoding='utf-8')"

            git add cache/manifest.json
            if ! git diff --cached --quiet; then
              git commit -m "Update manifest (pin data urls)"
            fi

            MANIFEST_SNAPSHOT_SHA="$(git rev-parse HEAD)"
            export MANIFEST_SNAPSHOT_SHA
            echo "MANIFEST_SNAPSHOT_SHA=${MANIFEST_SNAPSHOT_SHA}"

            # 5) Pin manifest_json to snapshot - PRETTY
            python -c "import json,os; from pathlib import Path; repo=os.environ['REPO']; snap=os.environ['MANIFEST_SNAPSHOT_SHA']; p=Path('cache/manifest.json'); obj=json.loads(p.read_text(encoding='utf-8')) if p.exists() else {}; obj.setdefault('pinned',{}); obj['pinned']['manifest_json']=f'https://raw.githubusercontent.com/{repo}/{snap}/cache/manifest.json'; obj['manifest_commit_sha']=snap; obj['manifest_commit_sha_v1']=snap; p.write_text(json.dumps(obj,ensure_ascii=False,indent=2)+\"\\n\",encoding='utf-8')"

            git add cache/manifest.json
            if ! git diff --cached --quiet; then
              git commit -m "Update manifest (pin manifest snapshot url)"
            fi

            HEAD_SHA="$(git rev-parse HEAD)"
            export HEAD_SHA
            echo "HEAD_SHA=${HEAD_SHA}"

            # 6) Push once; if fails, retry from origin/main
            if git push origin HEAD:main; then
              echo "Push succeeded."
              python -c "import json,os; from datetime import datetime,timezone; repo=os.environ['REPO']; data_sha=os.environ['DATA_SHA']; snap=os.environ['MANIFEST_SNAPSHOT_SHA']; head=os.environ['HEAD_SHA']; out={'generated_at_utc':datetime.now(timezone.utc).replace(microsecond=0).isoformat(),'head_commit_sha':head,'data_commit_sha':data_sha,'manifest_commit_sha':snap,'pinned':{'latest_json':f'https://raw.githubusercontent.com/{repo}/{data_sha}/cache/latest.json','history_json':f'https://raw.githubusercontent.com/{repo}/{data_sha}/cache/history.json','latest_csv':f'https://raw.githubusercontent.com/{repo}/{data_sha}/cache/latest.csv','manifest_json':f'https://raw.githubusercontent.com/{repo}/{snap}/cache/manifest.json'}}; print(json.dumps(out,ensure_ascii=False,separators=(',',':')))"
              exit 0
            fi

            echo "Push failed (likely non-fast-forward)."
            if [ "$attempt" -eq 1 ]; then sleep 2; fi
            if [ "$attempt" -eq 2 ]; then sleep 4; fi
            if [ "$attempt" -eq 3 ]; then sleep 8; fi
          done

          echo "Push failed after 3 attempts."
          exit 1