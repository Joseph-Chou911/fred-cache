name: tw0050-forward-return-conditional

on:
  workflow_run:
    workflows: ["tw0050-bb60-forwardmdd20"]
    types: [completed]
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: tw0050-forward-return-conditional
  cancel-in-progress: true

jobs:
  run:
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps (minimal)
        run: |
          python -m pip install --upgrade pip
          pip install pandas numpy

      - name: Build forward return conditional (hit-rate)
        shell: bash
        run: |
          set -euo pipefail
          set -x

          echo "=== list cache dir ==="
          ls -al tw0050_bb_cache || true
          echo "=== csv candidates ==="
          ls -al tw0050_bb_cache/*.csv || true

          # 1) pick price csv
          PRICE_CSV="price.csv"
          if [ ! -f "tw0050_bb_cache/${PRICE_CSV}" ]; then
            PRICE_CSV="$(python -c '
import glob, sys
cands = sorted(glob.glob("tw0050_bb_cache/*.csv"))
for p in cands:
    try:
        h = open(p, "r", encoding="utf-8", errors="ignore").readline().lower()
    except Exception:
        continue
    if "adjclose" in h or "adj_close" in h:
        print(p.split("/")[-1])
        sys.exit(0)
sys.exit(1)
')"
            echo "Auto-detected PRICE_CSV=${PRICE_CSV}"
          fi

          # 2) required inputs
          test -f "tw0050_bb_cache/${PRICE_CSV}"
          test -f "tw0050_bb_cache/stats_latest.json"
          test -f "scripts/build_tw0050_forward_return_conditional.py"

          # 3) run
          python scripts/build_tw0050_forward_return_conditional.py \
            --cache_dir tw0050_bb_cache \
            --price_csv "${PRICE_CSV}" \
            --stats_json stats_latest.json \
            --out_json forward_return_conditional.json \
            --bb_window 60 \
            --bb_k 2.0 \
            --bb_ddof 0 \
            --horizons 10,20 \
            --break_ratio_hi 1.8 \
            --break_ratio_lo 0.5555555556

      - name: Debug forward_return_conditional.json (existence)
        shell: bash
        run: |
          set -euo pipefail
          ls -al tw0050_bb_cache/forward_return_conditional.json
          python -c "import json; p='tw0050_bb_cache/forward_return_conditional.json'; j=json.load(open(p,'r',encoding='utf-8')); print('meta:', j.get('meta', {})); print('dq.flags:', j.get('dq', {}).get('flags', []))"

      - name: Commit artifacts (if changed)
        shell: bash
        run: |
          set -e
          if [ -n "$(git status --porcelain)" ]; then
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add tw0050_bb_cache/forward_return_conditional.json
            git commit -m "Update forward_return_conditional (hit-rate)"
            git push
          else
            echo "No changes to commit."
          fi