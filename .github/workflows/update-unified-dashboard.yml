name: Update Unified Dashboard

on:
  workflow_dispatch: {}
  schedule:
    # 09:30 Asia/Taipei = 01:30 UTC（可改）
    - cron: "30 1 * * *"

permissions:
  contents: write

concurrency:
  group: repo-writer-main
  cancel-in-progress: false

jobs:
  unified:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # --- Module A: market_cache ---
      - name: Build market_cache dashboard_latest.json
        id: market
        continue-on-error: true
        shell: bash
        run: |
          set -euo pipefail
          # TODO: 改成你原本產出 dashboard/dashboard_latest.json 的指令
          # 例如：python scripts/render_dashboard_market_cache.py
          echo "TODO: run market_cache pipeline"

      # --- Module B: fred_cache ---
      - name: Build fred_cache dashboard_latest.json
        id: fred
        continue-on-error: true
        shell: bash
        run: |
          set -euo pipefail
          # TODO: 改成你原本產出 dashboard_fred_cache/dashboard_latest.json 的指令
          # 例如：python scripts/render_dashboard_fred_cache.py
          echo "TODO: run fred_cache pipeline"

      # --- Module C: taiwan margin financing ---
      - name: Build taiwan margin financing latest.json
        id: twmargin
        continue-on-error: true
        shell: bash
        run: |
          set -euo pipefail
          # TODO: 改成你原本產出 taiwan_margin_cache/latest.json 的指令
          # 例如：python scripts/update_taiwan_margin_financing.py
          echo "TODO: run taiwan margin pipeline"

      # --- Merge (降級，不猜) ---
      - name: Build unified dashboard_latest.json
        shell: bash
        run: |
          set -euo pipefail
          python scripts/build_unified_dashboard_latest.py \
            --market_in  dashboard/dashboard_latest.json \
            --fred_in    dashboard_fred_cache/dashboard_latest.json \
            --twmargin_in taiwan_margin_cache/latest.json \
            --market_outcome "${{ steps.market.outcome }}" \
            --fred_outcome "${{ steps.fred.outcome }}" \
            --twmargin_outcome "${{ steps.twmargin.outcome }}" \
            --out dashboard_unified/dashboard_latest.json

      - name: Render unified report.md
        shell: bash
        run: |
          set -euo pipefail
          python scripts/render_unified_report_md.py \
            --in dashboard_unified/dashboard_latest.json \
            --out dashboard_unified/report.md

      - name: Commit unified dashboard
        shell: bash
        run: |
          set -euo pipefail
          git add dashboard_unified/dashboard_latest.json dashboard_unified/report.md
          git diff --cached --quiet || git commit -m "Update unified dashboard"
          git push