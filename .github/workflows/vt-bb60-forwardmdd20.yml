name: vt-bb60-forwardmdd20

on:
  workflow_dispatch:
  schedule:
    # 23:20 UTC = 07:20 Asia/Taipei (next day)
    - cron: "20 23 * * 1-5"

permissions:
  contents: write

concurrency:
  group: vt-bb60-forwardmdd20
  cancel-in-progress: true

jobs:
  run:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install pandas numpy yfinance pytz

      - name: Run VT monitor
        run: |
          python scripts/vt_bb60_forwardmdd20.py \
            --ticker VT \
            --cache_dir vt_bb_cache \
            --window 60 \
            --k 2.0 \
            --forward_days 20 \
            --fx_latest fx_cache/latest.json \
            --fx_history fx_cache/history.json \
            --max_history_rows 2500

      - name: Debug outputs
        run: |
          set -e
          pwd
          echo "---- ls repo root ----"
          ls -al
          echo "---- ls vt_bb_cache ----"
          ls -al vt_bb_cache || true
          echo "---- find vt_bb_cache files ----"
          find vt_bb_cache -maxdepth 2 -type f -print || true
          echo "---- git status ----"
          git status --porcelain || true
          echo "---- check ignore (if any) ----"
          git check-ignore -v vt_bb_cache/latest.json || true

      - name: Commit changes (if any)
        run: |
          set -e
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Force add (in case vt_bb_cache is ignored by .gitignore)
          git add -f vt_bb_cache/latest.json vt_bb_cache/history.json vt_bb_cache/report.md || true

          # If nothing staged, exit cleanly
          if git diff --cached --quiet; then
            echo "No staged changes."
            exit 0
          fi

          git commit -m "vt_bb_cache: update"
          git push