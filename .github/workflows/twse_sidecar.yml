name: Update TWSE sidecar (roll25 + latest_report + manifest)

on:
  workflow_dispatch: {}
  schedule:
    # Run at minute 8, every 9 hours (UTC): 00:08, 09:08, 18:08
    # Asia/Taipei (UTC+8): 08:08, 17:08, 02:08 (next day)
    - cron: "8 */9 * * *"

permissions:
  contents: write

concurrency:
  group: repo-writer-main
  cancel-in-progress: false

jobs:
  update:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          pip install --no-cache-dir requests

      - name: Generate + sanity + commit data + commit manifest + push (retry-safe)
        env:
          TZ: Asia/Taipei
        run: |
          set -euo pipefail

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          data_files=(
            "roll25_cache/roll25.json"
            "roll25_cache/latest_report.json"
          )

          for attempt in 1 2 3; do
            echo "===== Attempt ${attempt} ====="

            # Always start from latest remote main
            git fetch origin main
            git reset --hard origin/main
            git clean -fd

            echo "Runner time (UTC):    $(date -u '+%Y-%m-%d %H:%M:%S %Z')"
            echo "Runner time (Taipei): $(TZ=Asia/Taipei date '+%Y-%m-%d %H:%M:%S %Z')"

            # Force this run to actually regenerate data (avoid using old repo files)
            rm -f roll25_cache/roll25.json roll25_cache/latest_report.json roll25_cache/manifest.json || true

            # 1) Generate (FMTQIK failure => non-zero exit => workflow fails)
            python scripts/update_twse_sidecar.py

            # 2) Sanity (must fail if sanity fails)
            python scripts/sanity_twse_roll25.py

            # 3) Required files check (do not publish partial/broken outputs)
            missing=0
            for f in "${data_files[@]}"; do
              if [ ! -f "$f" ]; then
                echo "[ERROR] missing required file: $f"
                missing=1
              fi
            done
            if [ "$missing" -eq 1 ]; then
              echo "[ERROR] required outputs missing; abort."
              exit 1
            fi

            # 4) Fingerprint (audit only)
            for f in "${data_files[@]}"; do
              h="$(sha256sum "$f" | awk '{print $1}')"
              echo "$f  sha256=$h"
            done

            # 5) Commit DATA (first commit)
            git add -A "${data_files[@]}"
            if git diff --cached --quiet; then
              echo "No staged data changes to commit."
              echo "Manifest main URL:"
              echo "https://raw.githubusercontent.com/${GITHUB_REPOSITORY}/refs/heads/main/roll25_cache/manifest.json"
              exit 0
            fi

            git commit -m "Update TWSE data (roll25 + latest_report)"
            DATA_SHA="$(git rev-parse HEAD)"
            echo "DATA_SHA=${DATA_SHA}"

            # 6) Generate manifest.json pinned to DATA_SHA (second commit)
            python - <<'PY'
import json
import os
from datetime import datetime
from zoneinfo import ZoneInfo

repo = os.environ.get("GITHUB_REPOSITORY", "<OWNER>/<REPO>")
data_sha = os.environ.get("DATA_SHA", "UNKNOWN")

tz = ZoneInfo("Asia/Taipei")
now = datetime.now(tz).isoformat()

def raw(repo_slug: str, sha: str, path: str) -> str:
    return f"https://raw.githubusercontent.com/{repo_slug}/{sha}/{path}"

manifest = {
  "generated_at_taipei": now,
  "as_of_ts": now,

  # This is the ONLY SHA you should treat as the authoritative data snapshot.
  "data_commit_sha": data_sha,

  "pinned": {
    "schema_json": raw(repo, data_sha, "roll25_cache/twse_schema.json"),
    "roll25_json": raw(repo, data_sha, "roll25_cache/roll25.json"),
    "latest_report_json": raw(repo, data_sha, "roll25_cache/latest_report.json")
  },

  # Consumers should always fetch manifest from main, then jump to pinned.data URLs above.
  "manifest_main_json": f"https://raw.githubusercontent.com/{repo}/refs/heads/main/roll25_cache/manifest.json",

  "notes": "Read manifest from main (index). Then use pinned URLs (data_commit_sha) for audit-grade snapshots. Manifest is not self-pinned to avoid SHA self-reference."
}

os.makedirs("roll25_cache", exist_ok=True)
with open("roll25_cache/manifest.json", "w", encoding="utf-8") as f:
    json.dump(manifest, f, ensure_ascii=False, indent=2)
PY

            git add -A roll25_cache/manifest.json
            if git diff --cached --quiet; then
              echo "[WARN] manifest has no changes; unexpected, but continue."
            else
              git commit -m "Update TWSE manifest (pin data ${DATA_SHA})"
            fi

            # 7) Push both commits together. If rejected, retry from latest origin/main.
            if git push origin HEAD:main; then
              echo "Push succeeded."
              echo "DATA snapshot URL:"
              echo "https://raw.githubusercontent.com/${GITHUB_REPOSITORY}/${DATA_SHA}/roll25_cache/latest_report.json"
              echo "Manifest main URL:"
              echo "https://raw.githubusercontent.com/${GITHUB_REPOSITORY}/refs/heads/main/roll25_cache/manifest.json"
              exit 0
            fi

            echo "Push failed (likely non-fast-forward). Backoff then retry."
            if [ "$attempt" -eq 1 ]; then sleep 2; fi
            if [ "$attempt" -eq 2 ]; then sleep 4; fi
            if [ "$attempt" -eq 3 ]; then sleep 8; fi
          done

          echo "Push failed after 3 attempts."
          exit 1