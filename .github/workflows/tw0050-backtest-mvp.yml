name: backtest-tw0050-mvp

on:
  workflow_dispatch:
    inputs:
      enable_tp_sl:
        description: "Enable BB tactical tp/sl strategy (0 or 1)"
        required: false
        default: "0"
      take_profit_pct:
        description: "TP percent for tp/sl (e.g. 0.02)"
        required: false
        default: "0.02"
      stop_loss_pct:
        description: "SL percent for tp/sl (e.g. 0.03)"
        required: false
        default: "0.03"

  schedule:
    # 22:35 Asia/Taipei = 14:35 UTC (Taiwan no DST)
    - cron: "35 14 * * 1-5"

  push:
    paths:
      - "backtest_tw0050_leverage_mvp.py"
      - ".github/workflows/backtest_tw0050_mvp.yml"

permissions:
  contents: write

concurrency:
  group: backtest-tw0050-mvp
  cancel-in-progress: false

jobs:
  backtest:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        shell: bash
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            pip install numpy pandas yfinance requests
          fi

      - name: Run backtest (default suite)
        shell: bash
        env:
          TZ: Asia/Taipei
          ENABLE_TP_SL: ${{ inputs.enable_tp_sl || '0' }}
          TP_PCT: ${{ inputs.take_profit_pct || '0.02' }}
          SL_PCT: ${{ inputs.stop_loss_pct || '0.03' }}
        run: |
          set -euo pipefail

          CACHE_DIR="tw0050_bb_cache"

          # Default run: keep behavior stable; outputs overwrite in cache_dir
          python backtest_tw0050_leverage_mvp.py \
            --cache_dir "${CACHE_DIR}" \
            --price_csv "data.csv" \
            --stats_json "stats_latest.json" \
            --price_col "adjclose" \
            --bb_window 60 \
            --bb_ddof 0 \
            --entry_z -1.5 \
            --exit_z 0.0 \
            --leverage_frac 0.2 \
            --borrow_apr 0.035 \
            --max_hold_days 0 \
            --fee_rate 0.001425 \
            --tax_rate 0.0010 \
            --slip_bps 5 \
            --cost_on "lever" \
            --strategy_suite "all" \
            --segment_split_date "auto" \
            --segment_break_rank 0 \
            --omit_trades \
            --out_json "backtest_mvp.json" \
            --out_equity_csv "backtest_mvp_equity.csv" \
            --out_trades_csv "backtest_mvp_trades.csv" \
            --out_compare_csv "backtest_strategy_compare.csv"

          # Optional run: enable tp/sl tactical BB strategy (separate outputs)
          if [ "${ENABLE_TP_SL}" = "1" ]; then
            python backtest_tw0050_leverage_mvp.py \
              --cache_dir "${CACHE_DIR}" \
              --price_csv "data.csv" \
              --stats_json "stats_latest.json" \
              --price_col "adjclose" \
              --bb_window 60 \
              --bb_ddof 0 \
              --entry_z -1.5 \
              --exit_z 0.0 \
              --leverage_frac 0.2 \
              --borrow_apr 0.035 \
              --max_hold_days 20 \
              --fee_rate 0.001425 \
              --tax_rate 0.0010 \
              --slip_bps 5 \
              --cost_on "lever" \
              --strategy_suite "single_bb" \
              --enable_tp_sl \
              --take_profit_pct "${TP_PCT}" \
              --stop_loss_pct "${SL_PCT}" \
              --omit_trades \
              --out_json "backtest_mvp_tp_sl.json" \
              --out_equity_csv "backtest_mvp_tp_sl_equity.csv" \
              --out_trades_csv "backtest_mvp_tp_sl_trades.csv" \
              --out_compare_csv "backtest_mvp_tp_sl_compare.csv"
          fi

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: backtest-outputs
          path: |
            tw0050_bb_cache/backtest_mvp*.json
            tw0050_bb_cache/backtest_mvp*.csv
            tw0050_bb_cache/equity_curve.*.csv
          if-no-files-found: warn

      - name: Commit outputs to repo
        shell: bash
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add tw0050_bb_cache/backtest_mvp*.json tw0050_bb_cache/backtest_mvp*.csv tw0050_bb_cache/equity_curve.*.csv || true

          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git commit -m "chore: update backtest mvp outputs"
          git push