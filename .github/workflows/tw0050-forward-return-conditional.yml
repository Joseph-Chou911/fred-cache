name: tw0050-forward-return-conditional

on:
  workflow_dispatch:
  schedule:
    - cron: "50 6 * * 1-5"

permissions:
  contents: write

concurrency:
  group: tw0050-forward-return-conditional
  cancel-in-progress: true

jobs:
  run:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install numpy pandas

      - name: Sanity check scripts and inputs
        run: |
          set -euo pipefail
          test -f scripts/build_tw0050_forward_return_conditional.py
          test -f scripts/render_tw0050_forward_return_conditional_report.py
          test -d tw0050_bb_cache
          test -f tw0050_bb_cache/data.csv
          test -f tw0050_bb_cache/stats_latest.json
          echo "OK: scripts and inputs exist"
          ls -la scripts | sed -n '1,120p'
          ls -la tw0050_bb_cache | sed -n '1,200p'

      - name: Build forward_return_conditional.json
        run: |
          set -euo pipefail
          python scripts/build_tw0050_forward_return_conditional.py \
            --cache_dir tw0050_bb_cache \
            --price_csv data.csv \
            --stats_json stats_latest.json \
            --out_json forward_return_conditional.json \
            --bb_window 60 \
            --bb_k 2.0 \
            --bb_ddof 0 \
            --horizons "10,20" \
            --break_ratio_hi 1.8 \
            --break_ratio_lo 0.5555555556 \
            --raw_min_contam_threshold -0.40 \
            --lookback_years 0 \
            --break_samples_n 5 \
            --excluded_entries_sample_n 5

      - name: Render report.md
        run: |
          set -euo pipefail
          python scripts/render_tw0050_forward_return_conditional_report.py \
            --cache_dir tw0050_bb_cache \
            --in_json forward_return_conditional.json \
            --out_md forward_return_conditional_report.md \
            --stats_json stats_latest.json

      - name: Git status (debug)
        run: |
          set -euo pipefail
          git status --porcelain
          ls -la tw0050_bb_cache/forward_return_conditional.json
          ls -la tw0050_bb_cache/forward_return_conditional_report.md

      - name: Commit and push (if changed)
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add -A tw0050_bb_cache/forward_return_conditional.json tw0050_bb_cache/forward_return_conditional_report.md

          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git commit -m "update tw0050 forward return conditional report"
          git push