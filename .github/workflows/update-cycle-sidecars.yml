name: Update cycle sidecars (inflation_realrate + asset_proxy)

on:
  workflow_dispatch:
    inputs:
      backfill_start:
        description: "Optional. YYYY-MM-DD. If set, backfill history from this date (inclusive)."
        required: false
        default: ""
      backfill_end:
        description: "Optional. YYYY-MM-DD. If set, backfill history until this date (inclusive). Default=today UTC."
        required: false
        default: ""
      force_backfill:
        description: "Optional. true/false. If true, ignore backfill_done.flag and force backfill."
        required: false
        default: "false"
  schedule:
    # Every 8 hours at minute 21 (UTC): 00:21, 08:21, 16:21
    # Asia/Taipei (UTC+8): 08:21, 16:21, 00:21(next day)
    - cron: "21 */8 * * *"

permissions:
  contents: write

concurrency:
  group: repo-writer-main
  cancel-in-progress: false

jobs:
  update:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Sync to latest main (ff-only)
        run: |
          set -euo pipefail
          git fetch origin main
          git checkout main
          git merge --ff-only origin/main

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          pip install --no-cache-dir requests

      - name: Generate sidecar data
        env:
          TZ: Asia/Taipei
          FRED_API_KEY: ${{ secrets.FRED_API_KEY }}
          BACKFILL_START: ${{ github.event.inputs.backfill_start }}
          BACKFILL_END: ${{ github.event.inputs.backfill_end }}
          FORCE_BACKFILL: ${{ github.event.inputs.force_backfill }}
        run: |
          set -euo pipefail

          EXTRA_ARGS=""

          if [ -n "${BACKFILL_START:-}" ]; then
            EXTRA_ARGS="$EXTRA_ARGS --backfill_start ${BACKFILL_START}"
          fi
          if [ -n "${BACKFILL_END:-}" ]; then
            EXTRA_ARGS="$EXTRA_ARGS --backfill_end ${BACKFILL_END}"
          fi
          if [ "${FORCE_BACKFILL:-false}" = "true" ]; then
            EXTRA_ARGS="$EXTRA_ARGS --force_backfill"
          fi

          echo "Running: python scripts/update_cycle_sidecars.py --tz Asia/Taipei $EXTRA_ARGS"
          python scripts/update_cycle_sidecars.py --tz Asia/Taipei $EXTRA_ARGS

      - name: Commit DATA (if changed)
        id: commit_data
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git add inflation_realrate_cache asset_proxy_cache

          if git diff --cached --quiet; then
            echo "changed=0" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          git commit -m "Update cycle sidecars data"
          echo "changed=1" >> "$GITHUB_OUTPUT"
          echo "data_sha=$(git rev-parse HEAD)" >> "$GITHUB_OUTPUT"

      - name: Write manifests (pinned.data -> DATA_SHA)
        if: steps.commit_data.outputs.changed == '1'
        env:
          TZ: Asia/Taipei
        run: |
          set -euo pipefail
          python scripts/write_cycle_sidecar_manifests.py \
            --repo "Joseph-Chou911/fred-cache" \
            --data-sha "${{ steps.commit_data.outputs.data_sha }}" \
            --tz Asia/Taipei

      - name: Commit MANIFEST (if changed)
        if: steps.commit_data.outputs.changed == '1'
        run: |
          set -euo pipefail
          git add inflation_realrate_cache/manifest.json asset_proxy_cache/manifest.json

          if git diff --cached --quiet; then
            exit 0
          fi

          git commit -m "Update cycle sidecars manifest"

      - name: Push (no rebase; merge on conflict)
        if: steps.commit_data.outputs.changed == '1'
        run: |
          set -euo pipefail

          for i in 1 2 3; do
            if git push; then
              exit 0
            fi

            echo "push failed (likely non-fast-forward). Fetch+merge and retry..."
            git fetch origin main
            git merge --no-edit origin/main || true

            sleep $((2**i))
          done

          echo "ERROR: git push failed after retries"
          exit 1