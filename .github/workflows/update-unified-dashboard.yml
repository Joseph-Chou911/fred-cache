name: Update Unified Dashboard (merge+render)

on:
  workflow_dispatch: {}
  schedule:
    # 23:30 Asia/Taipei = 15:30 UTC
    - cron: "30 15 * * *"

permissions:
  contents: write

concurrency:
  group: repo-writer-main
  cancel-in-progress: false

jobs:
  unified:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Python deps (requests)
        shell: bash
        run: |
          set -euo pipefail
          python -V
          python -m pip install --upgrade pip
          python -m pip install --upgrade requests
          python -c "import requests; print('requests_version=', requests.__version__)"

      - name: Ensure output dirs
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p unified_dashboard fx_cache

      - name: Verify required inputs exist
        shell: bash
        run: |
          set -euo pipefail
          req=(
            "dashboard/dashboard_latest.json"
            "dashboard_fred_cache/dashboard_latest.json"
            "taiwan_margin_cache/latest.json"
            "roll25_cache/latest_report.json"
            "scripts/build_unified_dashboard_latest.py"
            "scripts/render_unified_report_md.py"
            "scripts/fetch_fx_usdtwd_bot.py"
          )
          missing=0
          for f in "${req[@]}"; do
            if [[ ! -f "$f" ]]; then
              echo "MISSING: $f"
              missing=1
            else
              echo "OK: $f"
            fi
          done
          if [[ "$missing" -ne 0 ]]; then
            echo "Required files missing. Stop."
            exit 1
          fi

      - name: Update FX cache (BOT USD/TWD) [STRICT]
        shell: bash
        run: |
          set -euo pipefail

          # Run fetcher. It should exit non-zero if strict sanity fails.
          python scripts/fetch_fx_usdtwd_bot.py \
            --tz "Asia/Taipei" \
            --latest-out "fx_cache/latest.json" \
            --history "fx_cache/history.json" \
            --max-back 10 \
            --timeout 20

          # Hard guards: outputs must exist and be non-empty
          test -s fx_cache/latest.json
          test -s fx_cache/history.json

          echo "OK: fx_cache/latest.json size=$(wc -c < fx_cache/latest.json)"
          echo "OK: fx_cache/history.json size=$(wc -c < fx_cache/history.json)"

          echo "---- fx_cache/latest.json (head 120) ----"
          sed -n '1,120p' fx_cache/latest.json || true

      - name: Build unified_dashboard/latest.json
        shell: bash
        env:
          ROLL25_VOL_N: "10"
          ROLL25_DD_N: "10"
        run: |
          set -euo pipefail

          # Require FX inputs produced by previous step
          test -s fx_cache/latest.json
          test -s fx_cache/history.json

          python scripts/build_unified_dashboard_latest.py \
            --market-in "dashboard/dashboard_latest.json" \
            --fred-in "dashboard_fred_cache/dashboard_latest.json" \
            --twmargin-in "taiwan_margin_cache/latest.json" \
            --roll25-in "roll25_cache/latest_report.json" \
            --fx-in "fx_cache/latest.json" \
            --fx-history "fx_cache/history.json" \
            --out "unified_dashboard/latest.json"

          test -s unified_dashboard/latest.json
          echo "OK: unified_dashboard/latest.json size=$(wc -c < unified_dashboard/latest.json)"

      - name: Render unified_dashboard/report.md
        shell: bash
        run: |
          set -euo pipefail

          in_path="unified_dashboard/latest.json"
          out_path="unified_dashboard/report.md"

          # Pre-guard: root report.md should NOT exist before render.
          if [[ -f "report.md" ]]; then
            echo "ERROR: root report.md exists BEFORE render. This indicates stale/duplicate output."
            ls -la report.md || true
            exit 1
          fi

          python scripts/render_unified_report_md.py \
            --in "$in_path" \
            --out "$out_path"

          test -s "$out_path"
          echo "OK: $out_path size=$(wc -c < "$out_path")"

          # Post-guard: renderer must NOT create root report.md.
          if [[ -f "report.md" ]]; then
            echo "ERROR: root report.md was created AFTER render. Renderer/output path may be broken."
            ls -la report.md || true
            exit 1
          fi

      - name: Show brief outputs (for logs)
        shell: bash
        run: |
          set -euo pipefail
          echo "---- git status ----"
          git status --porcelain || true

          echo "---- unified_dashboard/latest.json (head 30) ----"
          sed -n '1,30p' unified_dashboard/latest.json || true

          echo "---- unified_dashboard/report.md (head 60) ----"
          sed -n '1,60p' unified_dashboard/report.md || true

          echo "---- unified_dashboard/report.md (tail 15) ----"
          tail -n 15 unified_dashboard/report.md || true

          echo "---- fx_cache/latest.json (head 80) ----"
          sed -n '1,80p' fx_cache/latest.json || true

      - name: Commit & push if changed
        shell: bash
        run: |
          set -euo pipefail

          # Fail fast if outputs are ignored
          if git check-ignore -q unified_dashboard/latest.json; then
            echo "ERROR: unified_dashboard/latest.json is ignored by .gitignore"
            exit 1
          fi
          if git check-ignore -q unified_dashboard/report.md; then
            echo "ERROR: unified_dashboard/report.md is ignored by .gitignore"
            exit 1
          fi
          if git check-ignore -q fx_cache/latest.json; then
            echo "ERROR: fx_cache/latest.json is ignored by .gitignore"
            exit 1
          fi
          if git check-ignore -q fx_cache/history.json; then
            echo "ERROR: fx_cache/history.json is ignored by .gitignore"
            exit 1
          fi

          if [[ -z "$(git status --porcelain)" ]]; then
            echo "No changes. Skip commit."
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Only stage intended outputs
          git add unified_dashboard/latest.json unified_dashboard/report.md
          git add fx_cache/latest.json fx_cache/history.json
          git add -u

          # Hard-guard: refuse to commit staged changes outside unified_dashboard/ or fx_cache/
          staged_paths="$(git diff --cached --name-only || true)"
          bad_paths="$(echo "$staged_paths" | awk 'NF && $0 !~ /^(unified_dashboard|fx_cache)\// {print $0}')"
          if [[ -n "$bad_paths" ]]; then
            echo "ERROR: Refusing to commit staged changes outside unified_dashboard/ or fx_cache/:"
            echo "$bad_paths"
            echo "Hint: remove unintended changes or adjust staging rules."
            exit 1
          fi

          git commit -m "Update unified dashboard + report + FX cache"
          git push