name: Update Unified Dashboard (merge-only)

on:
  workflow_dispatch: {}
  schedule:
    # 09:30 Asia/Taipei = 01:30 UTC（可改）
    - cron: "30 1 * * *"

permissions:
  contents: write

concurrency:
  group: repo-writer-main
  cancel-in-progress: false

jobs:
  unified:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Check input files exist
        id: check
        shell: bash
        run: |
          set -euo pipefail

          m="missing"; f="missing"; t="missing"

          [ -f dashboard/dashboard_latest.json ] && m="present"
          [ -f dashboard_fred_cache/dashboard_latest.json ] && f="present"
          [ -f taiwan_margin_cache/latest.json ] && t="present"

          echo "market_file=$m" >> $GITHUB_OUTPUT
          echo "fred_file=$f" >> $GITHUB_OUTPUT
          echo "twmargin_file=$t" >> $GITHUB_OUTPUT

          echo "market_file=$m"
          echo "fred_file=$f"
          echo "twmargin_file=$t"

      - name: Build unified dashboard_latest.json
        shell: bash
        run: |
          set -euo pipefail
          python scripts/build_unified_dashboard_latest.py \
            --market_in  dashboard/dashboard_latest.json \
            --fred_in    dashboard_fred_cache/dashboard_latest.json \
            --twmargin_in taiwan_margin_cache/latest.json \
            --market_outcome "${{ steps.check.outputs.market_file }}" \
            --fred_outcome "${{ steps.check.outputs.fred_file }}" \
            --twmargin_outcome "${{ steps.check.outputs.twmargin_file }}" \
            --out dashboard_unified/dashboard_latest.json

      - name: Render unified report.md
        shell: bash
        run: |
          set -euo pipefail
          python scripts/render_unified_report_md.py \
            --in dashboard_unified/dashboard_latest.json \
            --out dashboard_unified/report.md

      - name: Commit unified dashboard
        shell: bash
        run: |
          set -euo pipefail
          git add dashboard_unified/dashboard_latest.json dashboard_unified/report.md
          git diff --cached --quiet || git commit -m "Update unified dashboard (merge-only)"
          git push