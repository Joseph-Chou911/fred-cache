name: Update FRED cache

on:
  workflow_dispatch: {}
  schedule:
    # minute 07 of every 6th hour (UTC): 00:07, 06:07, 12:07, 18:07
    - cron: "7 */6 * * *"

permissions:
  contents: write

concurrency:
  group: repo-writer-main
  cancel-in-progress: false

jobs:
  update:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    env:
      TIMEZONE: Asia/Taipei

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        shell: bash
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          pip install --no-cache-dir requests

      - name: Configure git author
        shell: bash
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Generate + sanity + commit + patch-meta + push (retry-safe)
        shell: bash
        env:
          FRED_API_KEY: ${{ secrets.FRED_API_KEY }}
          REPO: ${{ github.repository }}
        run: |
          set -euo pipefail

          for attempt in 1 2 3; do
            echo "===== Attempt ${attempt} ====="

            git fetch origin main
            git reset --hard origin/main
            git clean -fd

            # 1) Generate
            python scripts/fred_cache.py

            # 2) Sanity check
            python scripts/sanity_check_history.py

            # 3) Commit data snapshot (Commit 1)
            git add -A cache
            if git diff --cached --quiet; then
              echo "No changes in cache/. Exit."
              exit 0
            fi

            git commit -m "Update FRED cache data" --no-verify
            DATA_SHA="$(git rev-parse HEAD)"
            echo "DATA_SHA=${DATA_SHA}"

            # 4) Patch stats_latest.json metadata -> DATA_SHA (keep audit consistent)
            python scripts/patch_stats.py --data-sha "$DATA_SHA"
            git add cache/stats_latest.json || true

            # 5) Patch manifest pinned.* -> DATA_SHA (overwrite pinned fully)
            python scripts/patch_manifest.py --repo "$REPO" --data-sha "$DATA_SHA"
            git add cache/manifest.json

            # Commit meta patch if any change
            if ! git diff --cached --quiet; then
              git commit -m "Patch stats/meta + manifest pinned to DATA_SHA" --no-verify
            fi

            # 6) Push once
            if git push origin HEAD:main; then
              echo "Push succeeded."
              exit 0
            fi

            echo "Push failed (likely non-fast-forward)."
            if [ "$attempt" -eq 1 ]; then sleep 2; fi
            if [ "$attempt" -eq 2 ]; then sleep 4; fi
            if [ "$attempt" -eq 3 ]; then sleep 8; fi
          done

          echo "Push failed after 3 attempts."
          exit 1