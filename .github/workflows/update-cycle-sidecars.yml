name: Update cycle sidecars (inflation_realrate + asset_proxy + dashboards)

on:
  workflow_dispatch: {}
  schedule:
    # Every 8 hours at minute 21 (UTC): 00:21, 08:21, 16:21
    # Asia/Taipei (UTC+8): 08:21, 16:21, 00:21(next day)
    - cron: "21 */8 * * *"

permissions:
  contents: write

concurrency:
  # IMPORTANT: serialize pushes with your other writer workflows
  group: repo-writer-main
  cancel-in-progress: false

jobs:
  update:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Sync to latest main (ff-only)
        run: |
          set -euo pipefail
          git fetch origin main
          git checkout main
          git merge --ff-only origin/main

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          pip install --no-cache-dir requests

      # ------------------------------------------------------------
      # 1) Generate latest.json + history.json (authoritative raw)
      # ------------------------------------------------------------
      - name: Generate sidecar raw data (latest/history)
        env:
          TZ: Asia/Taipei
          FRED_API_KEY: ${{ secrets.FRED_API_KEY }}
        run: |
          set -euo pipefail
          python scripts/update_cycle_sidecars.py --tz Asia/Taipei

      - name: Debug dump raw as_of_ts
        run: |
          set -euo pipefail
          echo "== inflation_realrate_cache/latest.json as_of_ts =="
          python - <<'PY'
          import json
          p="inflation_realrate_cache/latest.json"
          a=json.load(open(p,"r",encoding="utf-8"))
          print(a[0]["as_of_ts"] if a else "NA")
          PY
          echo "== asset_proxy_cache/latest.json as_of_ts =="
          python - <<'PY'
          import json
          p="asset_proxy_cache/latest.json"
          a=json.load(open(p,"r",encoding="utf-8"))
          print(a[0]["as_of_ts"] if a else "NA")
          PY

      # ------------------------------------------------------------
      # 2) Compute stats_latest.json from history.json (must follow raw)
      # ------------------------------------------------------------
      - name: Compute stats (inflation_realrate_cache)
        env:
          TZ: Asia/Taipei
        run: |
          set -euo pipefail
          python scripts/compute_cycle_sidecars_stats.py \
            --cache-dir inflation_realrate_cache \
            --tz Asia/Taipei

      - name: Compute stats (asset_proxy_cache)
        env:
          TZ: Asia/Taipei
        run: |
          set -euo pipefail
          python scripts/compute_cycle_sidecars_stats.py \
            --cache-dir asset_proxy_cache \
            --tz Asia/Taipei

      # ------------------------------------------------------------
      # 3) Render dashboard report.md + dashboard_latest.json
      # ------------------------------------------------------------
      - name: Render dashboard (inflation_realrate_cache)
        env:
          TZ: Asia/Taipei
        run: |
          set -euo pipefail
          python scripts/render_dashboard.py \
            --stats inflation_realrate_cache/stats_latest.json \
            --dash-history inflation_realrate_cache/history_dashboard.json \
            --out-md inflation_realrate_cache/report.md \
            --out-json inflation_realrate_cache/dashboard_latest.json \
            --module inflation_realrate_cache \
            --stale-hours 36.0 \
            --ruleset-id signals_v8 \
            --script-fingerprint render_dashboard_py_signals_v8

      - name: Render dashboard (asset_proxy_cache)
        env:
          TZ: Asia/Taipei
        run: |
          set -euo pipefail
          python scripts/render_dashboard.py \
            --stats asset_proxy_cache/stats_latest.json \
            --dash-history asset_proxy_cache/history_dashboard.json \
            --out-md asset_proxy_cache/report.md \
            --out-json asset_proxy_cache/dashboard_latest.json \
            --module asset_proxy_cache \
            --stale-hours 36.0 \
            --ruleset-id signals_v8 \
            --script-fingerprint render_dashboard_py_signals_v8

      # ------------------------------------------------------------
      # 3.5) GUARDS (hard fail if any mismatch)  ✅新增
      # ------------------------------------------------------------

      # Guard A: inflation_realrate_cache latest == stats == dashboard meta
      - name: Guard A (inflation_realrate_cache): latest == stats == dashboard meta
        run: |
          set -euo pipefail
          python - <<'PY'
          import json
          latest = json.load(open("inflation_realrate_cache/latest.json","r",encoding="utf-8"))
          latest_ts = (latest[0]["as_of_ts"] if latest else "NA")
          stats_ts = json.load(open("inflation_realrate_cache/stats_latest.json","r",encoding="utf-8")).get("as_of_ts","NA")
          dash_ts  = json.load(open("inflation_realrate_cache/dashboard_latest.json","r",encoding="utf-8")).get("meta",{}).get("stats_as_of_ts","NA")
          print("latest:", latest_ts)
          print("stats :", stats_ts)
          print("dash  :", dash_ts)
          assert latest_ts != "NA" and stats_ts != "NA" and dash_ts != "NA", "NA found in timestamps"
          assert latest_ts == stats_ts == dash_ts, f"MISMATCH: latest={latest_ts} stats={stats_ts} dash={dash_ts}"
          print("OK: Guard A passed")
          PY

      # Guard B: inflation_realrate_cache rows[*].as_of_ts == meta.stats_as_of_ts
      - name: Guard B (inflation_realrate_cache): rows as_of_ts == meta.stats_as_of_ts
        run: |
          set -euo pipefail
          python - <<'PY'
          import json
          d = json.load(open("inflation_realrate_cache/dashboard_latest.json","r",encoding="utf-8"))
          meta_ts = d.get("meta",{}).get("stats_as_of_ts","NA")
          rows = d.get("rows",[]) or []
          bad = []
          for r in rows:
            if (r or {}).get("as_of_ts") != meta_ts:
              bad.append((r.get("series"), r.get("as_of_ts")))
          print("meta.stats_as_of_ts:", meta_ts)
          print("rows:", len(rows))
          assert meta_ts != "NA", "meta.stats_as_of_ts is NA"
          assert not bad, f"ROW_MISMATCH: {bad}"
          print("OK: Guard B passed")
          PY

      # Guard A: asset_proxy_cache latest == stats == dashboard meta
      - name: Guard A (asset_proxy_cache): latest == stats == dashboard meta
        run: |
          set -euo pipefail
          python - <<'PY'
          import json
          latest = json.load(open("asset_proxy_cache/latest.json","r",encoding="utf-8"))
          latest_ts = (latest[0]["as_of_ts"] if latest else "NA")
          stats_ts = json.load(open("asset_proxy_cache/stats_latest.json","r",encoding="utf-8")).get("as_of_ts","NA")
          dash_ts  = json.load(open("asset_proxy_cache/dashboard_latest.json","r",encoding="utf-8")).get("meta",{}).get("stats_as_of_ts","NA")
          print("latest:", latest_ts)
          print("stats :", stats_ts)
          print("dash  :", dash_ts)
          assert latest_ts != "NA" and stats_ts != "NA" and dash_ts != "NA", "NA found in timestamps"
          assert latest_ts == stats_ts == dash_ts, f"MISMATCH: latest={latest_ts} stats={stats_ts} dash={dash_ts}"
          print("OK: Guard A passed")
          PY

      # Guard B: asset_proxy_cache rows[*].as_of_ts == meta.stats_as_of_ts
      - name: Guard B (asset_proxy_cache): rows as_of_ts == meta.stats_as_of_ts
        run: |
          set -euo pipefail
          python - <<'PY'
          import json
          d = json.load(open("asset_proxy_cache/dashboard_latest.json","r",encoding="utf-8"))
          meta_ts = d.get("meta",{}).get("stats_as_of_ts","NA")
          rows = d.get("rows",[]) or []
          bad = []
          for r in rows:
            if (r or {}).get("as_of_ts") != meta_ts:
              bad.append((r.get("series"), r.get("as_of_ts")))
          print("meta.stats_as_of_ts:", meta_ts)
          print("rows:", len(rows))
          assert meta_ts != "NA", "meta.stats_as_of_ts is NA"
          assert not bad, f"ROW_MISMATCH: {bad}"
          print("OK: Guard B passed")
          PY

      # ------------------------------------------------------------
      # 4) Append dashboard history (ORDER-SAFE streak baseline)
      # ------------------------------------------------------------
      - name: Append dashboard history (inflation_realrate_cache)
        run: |
          set -euo pipefail
          python scripts/append_dashboard_history.py \
            --latest inflation_realrate_cache/dashboard_latest.json \
            --history inflation_realrate_cache/history_dashboard.json \
            --max-items 180

      - name: Append dashboard history (asset_proxy_cache)
        run: |
          set -euo pipefail
          python scripts/append_dashboard_history.py \
            --latest asset_proxy_cache/dashboard_latest.json \
            --history asset_proxy_cache/history_dashboard.json \
            --max-items 180

      - name: Commit DATA (if changed)
        id: commit_data
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git add inflation_realrate_cache asset_proxy_cache

          if git diff --cached --quiet; then
            echo "changed=0" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          git commit -m "Update cycle sidecars data+dashboards"
          echo "changed=1" >> "$GITHUB_OUTPUT"
          echo "data_sha=$(git rev-parse HEAD)" >> "$GITHUB_OUTPUT"

      - name: Write manifests (pinned.data -> DATA_SHA)
        if: steps.commit_data.outputs.changed == '1'
        env:
          TZ: Asia/Taipei
        run: |
          set -euo pipefail
          python scripts/write_cycle_sidecar_manifests.py \
            --repo "Joseph-Chou911/fred-cache" \
            --data-sha "${{ steps.commit_data.outputs.data_sha }}" \
            --tz Asia/Taipei

      - name: Commit MANIFEST (if changed)
        if: steps.commit_data.outputs.changed == '1'
        run: |
          set -euo pipefail
          git add inflation_realrate_cache/manifest.json asset_proxy_cache/manifest.json

          if git diff --cached --quiet; then
            exit 0
          fi

          git commit -m "Update cycle sidecars manifest"

      - name: Push (no rebase; merge on conflict)
        if: steps.commit_data.outputs.changed == '1'
        run: |
          set -euo pipefail

          for i in 1 2 3; do
            if git push; then
              exit 0
            fi

            echo "push failed (likely non-fast-forward). Fetch+merge and retry..."
            git fetch origin main
            git merge --no-edit origin/main || true

            sleep $((2**i))
          done

          echo "ERROR: git push failed after retries"
          exit 1