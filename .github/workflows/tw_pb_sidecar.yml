name: Update TW PB sidecar (tw_pb_cache + latest + stats + report + manifest)

on:
  workflow_dispatch:
    inputs:
      backfill_months:
        description: "One-shot backfill months (0=disabled). Suggested: 18~48"
        required: false
        default: "0"
  schedule:
    # Every 9 hours at minute 10 (UTC): 00:10, 09:10, 18:10
    # Asia/Taipei (UTC+8): 08:10, 17:10, 02:10 (next day)
    - cron: "10 */9 * * *"

permissions:
  contents: write

concurrency:
  group: repo-writer-main
  cancel-in-progress: false

jobs:
  update_daily:
    if: github.event_name == 'schedule' || (github.event_name == 'workflow_dispatch' && (github.event.inputs.backfill_months == '' || github.event.inputs.backfill_months == '0'))
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          pip install --no-cache-dir requests

      - name: Generate + sanity + report + commit + manifest + push (retry-safe, no-rebase)
        env:
          TZ: Asia/Taipei
        run: |
          set -euo pipefail

          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          data_files=(
            "tw_pb_cache/history.json"
            "tw_pb_cache/latest.json"
            "tw_pb_cache/stats_latest.json"
            "tw_pb_cache/report.md"
          )
          manifest_file="tw_pb_cache/manifest.json"

          for attempt in 1 2 3; do
            echo "===== Attempt ${attempt} (daily) ====="

            git fetch origin main
            git reset --hard origin/main
            git clean -fd

            echo "Runner time (UTC):    $(date -u '+%Y-%m-%d %H:%M:%S %Z')"
            echo "Runner time (Taipei): $(TZ=Asia/Taipei date '+%Y-%m-%d %H:%M:%S %Z')"

            start_epoch="$(date +%s)"

            # 1) Generate data
            python scripts/update_tw_pb_sidecar.py

            # 2) Sanity
            python scripts/sanity_tw_pb.py

            # 3) Render report
            python scripts/render_tw_pb_report_md.py \
              --latest "tw_pb_cache/latest.json" \
              --stats  "tw_pb_cache/stats_latest.json" \
              --history "tw_pb_cache/history.json" \
              --out    "tw_pb_cache/report.md"

            # 4) Required outputs & stale-mtime check
            missing=0
            for f in "${data_files[@]}"; do
              if [ ! -f "$f" ]; then
                echo "[ERROR] missing required file: $f"
                missing=1
                continue
              fi
              mtime="$(stat -c %Y "$f" || echo 0)"
              if [ "$mtime" -lt "$start_epoch" ]; then
                echo "[ERROR] $f was not updated by this run (stale mtime)"
                missing=1
              fi
            done
            if [ "$missing" -eq 1 ]; then
              echo "[ERROR] required outputs missing or stale; abort."
              exit 1
            fi

            # 5) Fingerprint
            for f in "${data_files[@]}"; do
              h="$(sha256sum "$f" | awk '{print $1}')"
              echo "$f  sha256=$h"
            done

            # 6) Commit DATA
            git add -A "${data_files[@]}"
            if git diff --cached --quiet; then
              echo "No staged data changes to commit."
              echo "Manifest main URL:"
              echo "https://raw.githubusercontent.com/${GITHUB_REPOSITORY}/refs/heads/main/${manifest_file}"
              exit 0
            fi

            git commit -m "Update TW PB sidecar data (history + latest + stats + report)"
            DATA_SHA="$(git rev-parse HEAD)"
            echo "DATA_SHA=${DATA_SHA}"

            # 7) Generate manifest pinned to DATA_SHA
            python scripts/write_tw_pb_manifest.py --data-sha "${DATA_SHA}" --out "${manifest_file}"

            git add -A "${manifest_file}"
            if git diff --cached --quiet; then
              echo "[ERROR] manifest.json did not change after generation (unexpected)."
              exit 1
            fi

            git commit -m "Update TW PB manifest (pinned to ${DATA_SHA})"
            MANIFEST_SHA="$(git rev-parse HEAD)"
            echo "MANIFEST_SHA=${MANIFEST_SHA}"

            echo "Snapshot URLs:"
            echo "  DATA latest (immutable):  https://raw.githubusercontent.com/${GITHUB_REPOSITORY}/${DATA_SHA}/tw_pb_cache/latest.json"
            echo "  REPORT (immutable):       https://raw.githubusercontent.com/${GITHUB_REPOSITORY}/${DATA_SHA}/tw_pb_cache/report.md"
            echo "  MANIFEST (immutable):     https://raw.githubusercontent.com/${GITHUB_REPOSITORY}/${MANIFEST_SHA}/tw_pb_cache/manifest.json"
            echo "  MANIFEST (main):          https://raw.githubusercontent.com/${GITHUB_REPOSITORY}/refs/heads/main/tw_pb_cache/manifest.json"

            if git push origin HEAD:main; then
              echo "Push succeeded."
              exit 0
            fi

            echo "Push failed (likely non-fast-forward). Backoff then retry."
            if [ "$attempt" -eq 1 ]; then sleep 2; fi
            if [ "$attempt" -eq 2 ]; then sleep 4; fi
            if [ "$attempt" -eq 3 ]; then sleep 8; fi
          done

          echo "Push failed after 3 attempts."
          exit 1

  backfill:
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.backfill_months != '' && github.event.inputs.backfill_months != '0'
    runs-on: ubuntu-latest
    timeout-minutes: 60

    concurrency:
      group: repo-writer-backfill
      cancel-in-progress: false

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          pip install --no-cache-dir requests

      - name: Backfill + sanity + report + commit + manifest + push (retry-safe, no-rebase)
        env:
          TZ: Asia/Taipei
          BACKFILL_MONTHS: ${{ github.event.inputs.backfill_months }}
        run: |
          set -euo pipefail

          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          data_files=(
            "tw_pb_cache/history.json"
            "tw_pb_cache/latest.json"
            "tw_pb_cache/stats_latest.json"
            "tw_pb_cache/report.md"
          )
          manifest_file="tw_pb_cache/manifest.json"

          for attempt in 1 2 3; do
            echo "===== Attempt ${attempt} (backfill) ====="

            git fetch origin main
            git reset --hard origin/main
            git clean -fd

            echo "Runner time (UTC):    $(date -u '+%Y-%m-%d %H:%M:%S %Z')"
            echo "Runner time (Taipei): $(TZ=Asia/Taipei date '+%Y-%m-%d %H:%M:%S %Z')"
            echo "BackfillMonths=${BACKFILL_MONTHS}"

            start_epoch="$(date +%s)"

            # 1) Generate (backfill)
            python scripts/update_tw_pb_sidecar.py --backfill-months "${BACKFILL_MONTHS}"

            # 2) Sanity
            python scripts/sanity_tw_pb.py

            # 3) Render report
            python scripts/render_tw_pb_report_md.py \
              --latest "tw_pb_cache/latest.json" \
              --stats  "tw_pb_cache/stats_latest.json" \
              --history "tw_pb_cache/history.json" \
              --out    "tw_pb_cache/report.md"

            # 4) Required outputs & stale-mtime check
            missing=0
            for f in "${data_files[@]}"; do
              if [ ! -f "$f" ]; then
                echo "[ERROR] missing required file: $f"
                missing=1
                continue
              fi
              mtime="$(stat -c %Y "$f" || echo 0)"
              if [ "$mtime" -lt "$start_epoch" ]; then
                echo "[ERROR] $f was not updated by this run (stale mtime)"
                missing=1
              fi
            done
            if [ "$missing" -eq 1 ]; then
              echo "[ERROR] required outputs missing or stale; abort."
              exit 1
            fi

            # 5) Fingerprint
            for f in "${data_files[@]}"; do
              h="$(sha256sum "$f" | awk '{print $1}')"
              echo "$f  sha256=$h"
            done

            # 6) Commit DATA
            git add -A "${data_files[@]}"
            if git diff --cached --quiet; then
              echo "No staged data changes to commit."
              echo "Manifest main URL:"
              echo "https://raw.githubusercontent.com/${GITHUB_REPOSITORY}/refs/heads/main/${manifest_file}"
              exit 0
            fi

            git commit -m "Backfill TW PB sidecar data (history + latest + stats + report)"
            DATA_SHA="$(git rev-parse HEAD)"
            echo "DATA_SHA=${DATA_SHA}"

            # 7) Manifest pinned to DATA_SHA
            python scripts/write_tw_pb_manifest.py --data-sha "${DATA_SHA}" --out "${manifest_file}"

            git add -A "${manifest_file}"
            if git diff --cached --quiet; then
              echo "[ERROR] manifest.json did not change after generation (unexpected)."
              exit 1
            fi

            git commit -m "Update TW PB manifest (pinned to ${DATA_SHA})"
            MANIFEST_SHA="$(git rev-parse HEAD)"
            echo "MANIFEST_SHA=${MANIFEST_SHA}"

            echo "Snapshot URLs:"
            echo "  DATA latest (immutable):  https://raw.githubusercontent.com/${GITHUB_REPOSITORY}/${DATA_SHA}/tw_pb_cache/latest.json"
            echo "  REPORT (immutable):       https://raw.githubusercontent.com/${GITHUB_REPOSITORY}/${DATA_SHA}/tw_pb_cache/report.md"
            echo "  MANIFEST (immutable):     https://raw.githubusercontent.com/${GITHUB_REPOSITORY}/${MANIFEST_SHA}/tw_pb_cache/manifest.json"
            echo "  MANIFEST (main):          https://raw.githubusercontent.com/${GITHUB_REPOSITORY}/refs/heads/main/tw_pb_cache/manifest.json"

            if git push origin HEAD:main; then
              echo "Push succeeded."
              exit 0
            fi

            echo "Push failed (likely non-fast-forward). Backoff then retry."
            if [ "$attempt" -eq 1 ]; then sleep 2; fi
            if [ "$attempt" -eq 2 ]; then sleep 4; fi
            if [ "$attempt" -eq 3 ]; then sleep 8; fi
          done

          echo "Push failed after 3 attempts."
          exit 1