name: Update Dashboard (fred_cache)

on:
  workflow_dispatch: {}
  schedule:
    # Daily at 15:10 UTC = 23:10 Asia/Taipei (you can change later)
    - cron: "10 15 * * *"

permissions:
  contents: write

concurrency:
  group: repo-writer-main
  cancel-in-progress: false

jobs:
  update:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    env:
      TIMEZONE: Asia/Taipei
      MODULE: fred_cache
      STALE_HOURS: "72"
      STATS_PATH: cache/stats_latest.json
      HISTORY_LITE_PATH: cache/history_lite.json
      DASH_DIR: dashboard_fred_cache
      OUT_MD: dashboard_fred_cache/latest.md
      LATEST_JSON: dashboard_fred_cache/dashboard_latest.json
      DASH_HISTORY: dashboard_fred_cache/history.json

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Prepare folders
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p "${DASH_DIR}"
          # Create an empty history.json if missing (append script can also do it, but this makes it explicit)
          if [ ! -f "${DASH_HISTORY}" ]; then
            cat > "${DASH_HISTORY}" <<'JSON'
{"schema_version":"dash_history_v1","items":[]}
JSON
          fi

      - name: Sanity check inputs exist
        shell: bash
        run: |
          set -euo pipefail
          test -f "${STATS_PATH}" || (echo "Missing ${STATS_PATH}. Did the cache update workflow run/commit?" && exit 1)
          test -f "${HISTORY_LITE_PATH}" || (echo "Missing ${HISTORY_LITE_PATH}. Did the cache update workflow run/commit?" && exit 1)

      - name: Render dashboard (fred_cache)
        shell: bash
        run: |
          set -euo pipefail
          python scripts/render_dashboard_fred_cache.py \
            --stats "${STATS_PATH}" \
            --history-lite "${HISTORY_LITE_PATH}" \
            --out-md "${OUT_MD}" \
            --dash-history "${DASH_HISTORY}" \
            --module "${MODULE}" \
            --stale-hours "${STALE_HOURS}"

          # Defensive: ensure the renderer produced the JSON that append step needs.
          # If your script writes JSON elsewhere, adjust LATEST_JSON accordingly.
          if [ ! -f "${LATEST_JSON}" ]; then
            echo "ERROR: expected latest JSON not found at ${LATEST_JSON}"
            echo "Directory listing:"
            ls -la "${DASH_DIR}" || true
            exit 1
          fi

      - name: Append dashboard history (fred_cache)
        shell: bash
        run: |
          set -euo pipefail
          python scripts/append_dashboard_history.py \
            --latest "${LATEST_JSON}" \
            --history "${DASH_HISTORY}" \
            --max-items 400

      - name: Configure git author
        shell: bash
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Commit changes (if any)
        shell: bash
        run: |
          set -euo pipefail
          git add "${DASH_DIR}/latest.md" "${DASH_DIR}/dashboard_latest.json" "${DASH_DIR}/history.json" || true
          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi
          git commit -m "dashboard_fred_cache: update latest + history"

      - name: Push
        shell: bash
        run: |
          set -euo pipefail
          git push