name: tw0050-backtest-mvp

on:
  workflow_dispatch:
  schedule:
    - cron: "10 7 * * 1-5"  # 可自行調整；避免跟既有工作同時跑

permissions:
  contents: write

concurrency:
  group: tw0050-backtest-mvp
  cancel-in-progress: true

jobs:
  run:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install pandas numpy

      - name: Run backtest (MVP)
        env:
          CACHE_DIR: tw0050_bb_cache
          PRICE_CSV: data.csv
          BORROW_APR: "0.035"
          LEVERAGE_ADD: "0.5"
          ENTER_Z: "-1.5"
          EXIT_Z: "0.0"
          MAX_HOLD_DAYS: "60"
        run: |
          set -euo pipefail

          python - << 'PY'
          import hashlib, os
          s = "|".join([
            os.environ["BORROW_APR"],
            os.environ["LEVERAGE_ADD"],
            os.environ["ENTER_Z"],
            os.environ["EXIT_Z"],
            os.environ["MAX_HOLD_DAYS"],
          ]).encode("utf-8")
          print(hashlib.sha1(s).hexdigest()[:10])
          PY

          FP=$(python - << 'PY'
          import hashlib, os
          s = "|".join([
            os.environ["BORROW_APR"],
            os.environ["LEVERAGE_ADD"],
            os.environ["ENTER_Z"],
            os.environ["EXIT_Z"],
            os.environ["MAX_HOLD_DAYS"],
          ]).encode("utf-8")
          print(hashlib.sha1(s).hexdigest()[:10])
          PY
          )

          OUT_EQ="equity_curve.${FP}.csv"
          OUT_SUM="backtest_mvp.${FP}.json"

          python scripts/backtest_tw0050_leverage_mvp.py \
            --cache_dir "${CACHE_DIR}" \
            --price_csv "${PRICE_CSV}" \
            --borrow_apr "${BORROW_APR}" \
            --leverage_add "${LEVERAGE_ADD}" \
            --enter_z "${ENTER_Z}" \
            --exit_z "${EXIT_Z}" \
            --max_hold_days "${MAX_HOLD_DAYS}" \
            --out_equity_csv "${OUT_EQ}" \
            --out_json "${OUT_SUM}"

          echo "Wrote:"
          ls -l "${CACHE_DIR}/${OUT_EQ}" "${CACHE_DIR}/${OUT_SUM}"

      - name: Commit outputs
        run: |
          set -euo pipefail
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add tw0050_bb_cache/equity_curve.*.csv tw0050_bb_cache/backtest_mvp.*.json

          if git diff --cached --quiet; then
            echo "No changes."
            exit 0
          fi

          git commit -m "tw0050 backtest mvp: update outputs"
          git push