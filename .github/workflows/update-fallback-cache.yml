name: Update fallback cache

on:
  workflow_dispatch: {}
  schedule:
    # Runs at minute 17 of every 7th hour: 00:17, 07:17, 14:17, 21:17 (UTC).
    # 換算台北時間（UTC+8）：08:17 / 15:17 / 22:17 / 05:17（隔天）
    - cron: "17 */7 * * *"

permissions:
  contents: write

concurrency:
  group: repo-writer-main
  cancel-in-progress: false

jobs:
  update:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        shell: bash
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            pip install "requests>=2.31.0"
          fi

      - name: Run fallback script
        shell: bash
        run: |
          set -euo pipefail
          python scripts/update_fallback_cache.py

      - name: Validate DATA JSON (latest.json)
        shell: bash
        run: |
          set -euo pipefail
          python -m json.tool fallback_cache/latest.json > /dev/null
          echo "latest.json is valid JSON."

      - name: Show outputs (debug)
        shell: bash
        run: |
          set -euo pipefail
          echo "---- git status (before commit) ----"
          git status --porcelain || true

          echo "---- ls fallback_cache ----"
          ls -al fallback_cache || true

          echo "---- preview fallback_cache/latest.json ----"
          head -n 60 fallback_cache/latest.json || true

          echo "---- preview fallback_cache/manifest.json (pre-regen) ----"
          cat fallback_cache/manifest.json || true

          echo "---- preview fallback_cache/latest.csv ----"
          head -n 30 fallback_cache/latest.csv || true

      - name: Commit & push DATA (latest.json/latest.csv) if changed
        shell: bash
        run: |
          set -euo pipefail

          push_with_rebase_retry () {
            for wait in 2 4 8; do
              echo "---- fetch/pull --rebase origin main ----"
              git fetch origin main
              git checkout -B main origin/main
              git pull --rebase --autostash origin main

              echo "---- try push (origin HEAD:main) ----"
              if git push origin HEAD:main; then
                echo "Push OK."
                return 0
              fi

              echo "Push failed. Retry after ${wait}s..."
              sleep "${wait}"
            done
            echo "ERROR: push failed after retries."
            return 1
          }

          # Ensure required files exist
          for f in fallback_cache/latest.json fallback_cache/latest.csv; do
            if [ ! -f "$f" ]; then
              echo "ERROR: missing file: $f"
              exit 1
            fi
          done

          git add fallback_cache/latest.json fallback_cache/latest.csv

          if git diff --cached --quiet; then
            echo "No DATA changes to commit."
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git commit -m "Update fallback DATA (latest json/csv)"

          push_with_rebase_retry

      - name: Regenerate MANIFEST with pinned SHA for DATA
        shell: bash
        env:
          REPO_OWNER: Joseph-Chou911
          REPO_NAME: fred-cache
        run: |
          set -euo pipefail

          # Pin to last commit that touched DATA files (more accurate than HEAD)
          SHA_DATA="$(git log -n 1 --pretty=%H -- fallback_cache/latest.json fallback_cache/latest.csv)"
          echo "SHA_DATA=$SHA_DATA"
          if [ -z "$SHA_DATA" ]; then
            echo "ERROR: SHA_DATA is empty"
            exit 1
          fi
          export SHA_DATA

          cat > /tmp/regenerate_fallback_manifest.py <<'PY'
          import json, os, datetime

          sha_data = os.environ.get("SHA_DATA")
          owner = os.environ.get("REPO_OWNER")
          repo  = os.environ.get("REPO_NAME")

          if not sha_data or sha_data.lower() == "none":
            raise SystemExit(f"ERROR: invalid SHA_DATA: {sha_data!r}")
          if not owner or not repo:
            raise SystemExit(f"ERROR: invalid REPO_OWNER/REPO_NAME: {owner!r}/{repo!r}")

          # Get script_version from latest.json (best-effort)
          script_version = "unknown"
          try:
            with open("fallback_cache/latest.json", "r", encoding="utf-8") as f:
              rows = json.load(f)
            if isinstance(rows, list):
              for r in rows:
                if r.get("series_id") == "__META__" and r.get("notes") == "INFO:script_version":
                  script_version = r.get("value") or script_version
                  break
          except Exception:
            pass

          now_utc = datetime.datetime.utcnow().replace(microsecond=0).isoformat() + "Z"

          latest_json = f"https://raw.githubusercontent.com/{owner}/{repo}/{sha_data}/fallback_cache/latest.json"
          latest_csv  = f"https://raw.githubusercontent.com/{owner}/{repo}/{sha_data}/fallback_cache/latest.csv"
          manifest_main = f"https://raw.githubusercontent.com/{owner}/{repo}/main/fallback_cache/manifest.json"

          out = {
            "generated_at_utc": now_utc,
            "as_of_ts": now_utc,
            "script_version": script_version,
            "data_commit_sha": sha_data,
            "pinned": {
              "latest_json": latest_json,
              "latest_csv": latest_csv,
              "manifest_json": manifest_main
            },
            "notes": [
              "Fallback cache; pinned points to DATA commit SHA.",
              "manifest_json remains main entry to avoid self-referential SHA."
            ]
          }

          with open("fallback_cache/manifest.json", "w", encoding="utf-8") as f:
            json.dump(out, f, ensure_ascii=False, indent=2)
            f.write("\n")
          PY

          python /tmp/regenerate_fallback_manifest.py

          echo "---- preview fallback_cache/manifest.json (post-regen) ----"
          cat fallback_cache/manifest.json

      - name: Validate MANIFEST JSON (manifest.json)
        shell: bash
        run: |
          set -euo pipefail
          python -m json.tool fallback_cache/manifest.json > /dev/null
          echo "manifest.json is valid JSON."

      - name: Commit & push MANIFEST if changed
        shell: bash
        run: |
          set -euo pipefail

          push_with_rebase_retry () {
            for wait in 2 4 8; do
              echo "---- fetch/pull --rebase origin main ----"
              git fetch origin main
              git checkout -B main origin/main
              git pull --rebase --autostash origin main

              echo "---- try push (origin HEAD:main) ----"
              if git push origin HEAD:main; then
                echo "Push OK."
                return 0
              fi

              echo "Push failed. Retry after ${wait}s..."
              sleep "${wait}"
            done
            echo "ERROR: push failed after retries."
            return 1
          }

          if [ ! -f fallback_cache/manifest.json ]; then
            echo "ERROR: missing file: fallback_cache/manifest.json"
            exit 1
          fi

          git add fallback_cache/manifest.json
          if git diff --cached --quiet; then
            echo "No MANIFEST changes to commit."
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git commit -m "Update fallback MANIFEST (pinned to data sha)"

          push_with_rebase_retry

      - name: Post status
        if: always()
        shell: bash
        run: |
          echo "Done."