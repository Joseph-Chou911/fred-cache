name: Update FRED cache

on:
  workflow_dispatch: {}
  schedule:
    # Every 6 hours at minute 7 (UTC): 00:07, 06:07, 12:07, 18:07
    # Asia/Taipei: 08:07, 14:07, 20:07, 02:07
    - cron: "7 */6 * * *"

permissions:
  contents: write

concurrency:
  group: fred-cache-main
  cancel-in-progress: true

jobs:
  update:
    runs-on: ubuntu-latest

    env:
      TIMEZONE: Asia/Taipei

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install requests

      # 1) 產出資料檔（latest/history/dq_state/manifest 初版）
      - name: Generate cache files
        env:
          FRED_API_KEY: ${{ secrets.FRED_API_KEY }}
        run: |
          set -euo pipefail
          python scripts/fred_cache.py

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      # 2) 第一次 commit：把「資料檔」commit 起來，取得 data_commit_sha
      - name: Commit data files (attempt 1)
        id: commit_data
        run: |
          set -euo pipefail

          git add -A cache

          if git diff --cached --quiet; then
            echo "no_changes=true" >> "$GITHUB_OUTPUT"
            echo "DATA_SHA=" >> "$GITHUB_ENV"
            exit 0
          fi

          git commit -m "Update cache (latest + history)"
          DATA_SHA="$(git rev-parse HEAD)"
          echo "no_changes=false" >> "$GITHUB_OUTPUT"
          echo "DATA_SHA=$DATA_SHA" >> "$GITHUB_ENV"

      - name: Push data commit
        if: steps.commit_data.outputs.no_changes != 'true'
        run: |
          set -euo pipefail
          git push

      # 3) 用 data_commit_sha 回填 manifest.json（先寫 pinned data urls；manifest 先暫時指向 main）
      - name: Patch manifest.json with pinned data URLs
        if: steps.commit_data.outputs.no_changes != 'true'
        env:
          DATA_SHA: ${{ env.DATA_SHA }}
          REPO: ${{ github.repository }}
        run: |
          set -euo pipefail
          python - << 'PY'
          import json, os
          from pathlib import Path

          data_sha = os.environ["DATA_SHA"]
          repo = os.environ["REPO"]

          p = Path("cache/manifest.json")
          obj = json.loads(p.read_text(encoding="utf-8")) if p.exists() else {}

          obj.setdefault("generated_at_utc", None)
          obj.setdefault("as_of_ts", None)

          obj["data_commit_sha"] = data_sha

          base = f"https://raw.githubusercontent.com/{repo}/{data_sha}/cache"
          obj["pinned"] = {
            "latest_json": f"{base}/latest.json",
            "history_json": f"{base}/history.json",
            "latest_csv":  f"{base}/latest.csv",
            # temporary (will be replaced by self-pin step)
            "manifest_json": f"https://raw.githubusercontent.com/{repo}/refs/heads/main/cache/manifest.json",
          }

          p.write_text(json.dumps(obj, ensure_ascii=False, separators=(",", ":")), encoding="utf-8")
          PY

      # 4) 第二次 commit：只 commit manifest.json，取得 manifest_commit_sha_v1
      - name: Commit manifest (attempt 1)
        if: steps.commit_data.outputs.no_changes != 'true'
        id: commit_manifest
        run: |
          set -euo pipefail

          git add cache/manifest.json

          if git diff --cached --quiet; then
            echo "MANIFEST_SHA=" >> "$GITHUB_ENV"
            exit 0
          fi

          git commit -m "Update manifest (pinned data urls)"
          MANIFEST_SHA="$(git rev-parse HEAD)"
          echo "MANIFEST_SHA=$MANIFEST_SHA" >> "$GITHUB_ENV"

      - name: Push manifest commit
        if: steps.commit_data.outputs.no_changes != 'true'
        run: |
          set -euo pipefail
          git push

      # 4.5) Self-pin：把 pinned.manifest_json 改成「指向 v1 sha 的 pinned manifest」
      # 再 commit 一次（v2），避免 refs/heads/main 快取風險
      - name: Patch manifest.json to pinned.manifest_json (self-pin)
        if: steps.commit_data.outputs.no_changes != 'true'
        env:
          REPO: ${{ github.repository }}
          MANIFEST_SHA: ${{ env.MANIFEST_SHA }}
        run: |
          set -euo pipefail
          python - << 'PY'
          import json, os
          from pathlib import Path

          repo = os.environ["REPO"]
          sha1 = (os.environ.get("MANIFEST_SHA") or "").strip()

          p = Path("cache/manifest.json")
          obj = json.loads(p.read_text(encoding="utf-8")) if p.exists() else {}
          obj.setdefault("pinned", {})

          if sha1:
            obj["pinned"]["manifest_json"] = f"https://raw.githubusercontent.com/{repo}/{sha1}/cache/manifest.json"
            obj["manifest_commit_sha_v1"] = sha1

          p.write_text(json.dumps(obj, ensure_ascii=False, separators=(",", ":")), encoding="utf-8")
          PY

      - name: Commit manifest (self-pin)
        if: steps.commit_data.outputs.no_changes != 'true'
        id: commit_manifest2
        run: |
          set -euo pipefail

          git add cache/manifest.json

          if git diff --cached --quiet; then
            echo "no_changes2=true" >> "$GITHUB_OUTPUT"
            echo "MANIFEST2_SHA=${MANIFEST_SHA}" >> "$GITHUB_ENV"
            exit 0
          fi

          git commit -m "Update manifest (pin manifest url)"
          MANIFEST2_SHA="$(git rev-parse HEAD)"
          echo "no_changes2=false" >> "$GITHUB_OUTPUT"
          echo "MANIFEST2_SHA=$MANIFEST2_SHA" >> "$GITHUB_ENV"

      - name: Push manifest (self-pin)
        if: steps.commit_data.outputs.no_changes != 'true' && steps.commit_manifest2.outputs.no_changes2 != 'true'
        run: |
          set -euo pipefail
          git push

      # 5) 在 Actions log 輸出 pinned pointers（含 pinned.manifest_json）
      - name: Print pinned pointers (single-line JSON)
        if: steps.commit_data.outputs.no_changes != 'true'
        env:
          DATA_SHA: ${{ env.DATA_SHA }}
          MANIFEST_SHA: ${{ env.MANIFEST_SHA }}
          MANIFEST2_SHA: ${{ env.MANIFEST2_SHA }}
          REPO: ${{ github.repository }}
        run: |
          set -euo pipefail
          python - << 'PY'
          import json, os
          from datetime import datetime, timezone

          repo = os.environ["REPO"]
          data_sha = (os.environ.get("DATA_SHA") or "").strip()
          sha1 = (os.environ.get("MANIFEST_SHA") or "").strip()
          sha2 = (os.environ.get("MANIFEST2_SHA") or "").strip() or sha1

          out = {
            "generated_at_utc": datetime.now(timezone.utc).replace(microsecond=0).isoformat(),
            "data_commit_sha": data_sha,
            "manifest_commit_sha_v1": sha1,
            "manifest_commit_sha_v2": sha2,
            "pinned": {
              "latest_json": f"https://raw.githubusercontent.com/{repo}/{data_sha}/cache/latest.json" if data_sha else "NA",
              "history_json": f"https://raw.githubusercontent.com/{repo}/{data_sha}/cache/history.json" if data_sha else "NA",
              "latest_csv":  f"https://raw.githubusercontent.com/{repo}/{data_sha}/cache/latest.csv"  if data_sha else "NA",
              "manifest_json": f"https://raw.githubusercontent.com/{repo}/{sha2}/cache/manifest.json" if sha2 else "NA",
            }
          }
          print(json.dumps(out, ensure_ascii=False, separators=(",", ":")))
          PY

      # 6) ✅ A 方案：只做驗收輸出（不改檔案），確認「每天是否新增一天」
      - name: Sanity check (history daily coverage)
        run: |
          set -euo pipefail
          python - << 'PY'
          import json
          from pathlib import Path
          from collections import Counter

          h = json.loads(Path("cache/history.json").read_text(encoding="utf-8"))

          days = sorted({r.get("as_of_ts","")[:10] for r in h if r.get("as_of_ts")})
          c = Counter(r.get("as_of_ts","")[:10] for r in h if r.get("as_of_ts"))

          keys = set((r.get("as_of_ts","")[:10], r.get("series_id","")) for r in h)
          dedupe_ok = (len(keys) == len(h))

          print("history_records =", len(h))
          print("days_in_history =", days)
          print("rows_per_day    =", dict(c))
          print("dedupe_ok       =", dedupe_ok)
          print("cap_records     =", 720, "cap_ok =", len(h) <= 720)
          PY