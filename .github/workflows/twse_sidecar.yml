name: Update TWSE sidecar (roll25 + latest_report + stats + manifest)

on:
  workflow_dispatch:
    inputs:
      backfill_months:
        description: "One-shot backfill months (0=disabled). Suggested: 18~24"
        required: false
        default: "0"
  schedule:
    # Every 9 hours at minute 8 (UTC): 00:08, 09:08, 18:08
    # Asia/Taipei (UTC+8): 08:08, 17:08, 02:08 (next day)
    - cron: "8 */9 * * *"

permissions:
  contents: write

concurrency:
  group: repo-writer-main
  cancel-in-progress: false

jobs:
  update_daily:
    if: github.event_name == 'schedule' || (github.event_name == 'workflow_dispatch' && (github.event.inputs.backfill_months == '' || github.event.inputs.backfill_months == '0'))
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          pip install --no-cache-dir requests

      - name: Generate + sanity + commit + manifest + push (retry-safe, no-rebase)
        env:
          TZ: Asia/Taipei
        run: |
          set -euo pipefail

          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          data_files=(
            "roll25_cache/roll25.json"
            "roll25_cache/latest_report.json"
            "roll25_cache/stats_latest.json"
            "roll25_cache/report.md"
          )
          manifest_file="roll25_cache/manifest.json"

          for attempt in 1 2 3; do
            echo "===== Attempt ${attempt} (daily) ====="

            git fetch origin main
            git reset --hard origin/main
            git clean -fd

            echo "Runner time (UTC):    $(date -u '+%Y-%m-%d %H:%M:%S %Z')"
            echo "Runner time (Taipei): $(TZ=Asia/Taipei date '+%Y-%m-%d %H:%M:%S %Z')"

            start_epoch="$(date +%s)"

            # 1) Generate
            python scripts/update_twse_sidecar.py

            # 2) Sanity
            python scripts/sanity_twse_roll25.py

            # 2.5) Render report.md (deterministic; no runtime stamp)
            python scripts/render_roll25_report_md.py \
              --latest-report roll25_cache/latest_report.json \
              --stats roll25_cache/stats_latest.json \
              --out roll25_cache/report.md

            # 3) Required outputs & stale-mtime check
            missing=0
            for f in "${data_files[@]}"; do
              if [ ! -f "$f" ]; then
                echo "[ERROR] missing required file: $f"
                missing=1
                continue
              fi
              mtime="$(stat -c %Y "$f" || echo 0)"
              if [ "$mtime" -lt "$start_epoch" ]; then
                echo "[ERROR] $f was not updated by this run (stale mtime)"
                missing=1
              fi
            done
            if [ "$missing" -eq 1 ]; then
              echo "[ERROR] required outputs missing or stale; abort."
              exit 1
            fi

            # 4) Fingerprint
            for f in "${data_files[@]}"; do
              h="$(sha256sum "$f" | awk '{print $1}')"
              echo "$f  sha256=$h"
            done

            # 5) Commit DATA
            git add -A "${data_files[@]}"
            if git diff --cached --quiet; then
              echo "No staged data changes to commit."
              echo "Manifest main URL:"
              echo "https://raw.githubusercontent.com/${GITHUB_REPOSITORY}/refs/heads/main/${manifest_file}"
              exit 0
            fi

            git commit -m "Update TWSE sidecar data (roll25 + latest_report + stats + report)"
            DATA_SHA="$(git rev-parse HEAD)"
            echo "DATA_SHA=${DATA_SHA}"

            # 6) Generate manifest pinned to DATA_SHA
            python scripts/write_twse_manifest.py --data-sha "${DATA_SHA}" --out "${manifest_file}"

            git add -A "${manifest_file}"
            if git diff --cached --quiet; then
              echo "[ERROR] manifest.json did not change after generation (unexpected)."
              exit 1
            fi

            git commit -m "Update TWSE manifest (pinned to ${DATA_SHA})"
            MANIFEST_SHA="$(git rev-parse HEAD)"
            echo "MANIFEST_SHA=${MANIFEST_SHA}"

            echo "Snapshot URLs:"
            echo "  DATA (immutable):     https://raw.githubusercontent.com/${GITHUB_REPOSITORY}/${DATA_SHA}/roll25_cache/latest_report.json"
            echo "  MANIFEST (immutable): https://raw.githubusercontent.com/${GITHUB_REPOSITORY}/${MANIFEST_SHA}/roll25_cache/manifest.json"
            echo "  MANIFEST (main):      https://raw.githubusercontent.com/${GITHUB_REPOSITORY}/refs/heads/main/roll25_cache/manifest.json"

            if git push origin HEAD:main; then
              echo "Push succeeded."
              exit 0
            fi

            echo "Push failed (likely non-fast-forward). Backoff then retry."
            if [ "$attempt" -eq 1 ]; then sleep 2; fi
            if [ "$attempt" -eq 2 ]; then sleep 4; fi
            if [ "$attempt" -eq 3 ]; then sleep 8; fi
          done

          echo "Push failed after 3 attempts."
          exit 1

  backfill:
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.backfill_months != '' && github.event.inputs.backfill_months != '0'
    runs-on: ubuntu-latest
    timeout-minutes: 60

    concurrency:
      group: repo-writer-backfill
      cancel-in-progress: false

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          pip install --no-cache-dir requests

      - name: Backfill + sanity + commit + manifest + push (retry-safe, no-rebase)
        env:
          TZ: Asia/Taipei
          BACKFILL_MONTHS: ${{ github.event.inputs.backfill_months }}
        run: |
          set -euo pipefail

          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          data_files=(
            "roll25_cache/roll25.json"
            "roll25_cache/latest_report.json"
            "roll25_cache/stats_latest.json"
            "roll25_cache/report.md"
          )
          manifest_file="roll25_cache/manifest.json"

          for attempt in 1 2 3; do
            echo "===== Attempt ${attempt} (backfill) ====="

            git fetch origin main
            git reset --hard origin/main
            git clean -fd

            echo "Runner time (UTC):    $(date -u '+%Y-%m-%d %H:%M:%S %Z')"
            echo "Runner time (Taipei): $(TZ=Asia/Taipei date '+%Y-%m-%d %H:%M:%S %Z')"
            echo "BackfillMonths=${BACKFILL_MONTHS}"

            start_epoch="$(date +%s)"

            # 1) Generate (backfill)
            python scripts/update_twse_sidecar.py --backfill-months "${BACKFILL_MONTHS}"

            # 2) Sanity
            python scripts/sanity_twse_roll25.py

            # 2.5) Render report.md (deterministic; no runtime stamp)
            python scripts/render_roll25_report_md.py \
              --latest-report roll25_cache/latest_report.json \
              --stats roll25_cache/stats_latest.json \
              --out roll25_cache/report.md

            # 3) Required outputs & stale-mtime check
            missing=0
            for f in "${data_files[@]}"; do
              if [ ! -f "$f" ]; then
                echo "[ERROR] missing required file: $f"
                missing=1
                continue
              fi
              mtime="$(stat -c %Y "$f" || echo 0)"
              if [ "$mtime" -lt "$start_epoch" ]; then
                echo "[ERROR] $f was not updated by this run (stale mtime)"
                missing=1
              fi
            done
            if [ "$missing" -eq 1 ]; then
              echo "[ERROR] required outputs missing or stale; abort."
              exit 1
            fi

            # 4) Fingerprint
            for f in "${data_files[@]}"; do
              h="$(sha256sum "$f" | awk '{print $1}')"
              echo "$f  sha256=$h"
            done

            # 5) Commit DATA
            git add -A "${data_files[@]}"
            if git diff --cached --quiet; then
              echo "No staged data changes to commit."
              echo "Manifest main URL:"
              echo "https://raw.githubusercontent.com/${GITHUB_REPOSITORY}/refs/heads/main/${manifest_file}"
              exit 0
            fi

            git commit -m "Backfill TWSE sidecar data (roll25 + latest_report + stats + report)"
            DATA_SHA="$(git rev-parse HEAD)"
            echo "DATA_SHA=${DATA_SHA}"

            # 6) Manifest pinned to DATA_SHA
            python scripts/write_twse_manifest.py --data-sha "${DATA_SHA}" --out "${manifest_file}"

            git add -A "${manifest_file}"
            if git diff --cached --quiet; then
              echo "[ERROR] manifest.json did not change after generation (unexpected)."
              exit 1
            fi

            git commit -m "Update TWSE manifest (pinned to ${DATA_SHA})"
            MANIFEST_SHA="$(git rev-parse HEAD)"
            echo "MANIFEST_SHA=${MANIFEST_SHA}"

            echo "Snapshot URLs:"
            echo "  DATA (immutable):     https://raw.githubusercontent.com/${GITHUB_REPOSITORY}/${DATA_SHA}/roll25_cache/latest_report.json"
            echo "  MANIFEST (immutable): https://raw.githubusercontent.com/${GITHUB_REPOSITORY}/${MANIFEST_SHA}/roll25_cache/manifest.json"
            echo "  MANIFEST (main):      https://raw.githubusercontent.com/${GITHUB_REPOSITORY}/refs/heads/main/roll25_cache/manifest.json"

            if git push origin HEAD:main; then
              echo "Push succeeded."
              exit 0
            fi

            echo "Push failed (likely non-fast-forward). Backoff then retry."
            if [ "$attempt" -eq 1 ]; then sleep 2; fi
            if [ "$attempt" -eq 2 ]; then sleep 4; fi
            if [ "$attempt" -eq 3 ]; then sleep 8; fi
          done

          echo "Push failed after 3 attempts."
          exit 1