name: Update TWSE sidecar (roll25 + latest_report + stats + manifest)

on:
  workflow_dispatch:
    inputs:
      backfill:
        description: "Run one-shot backfill job (0=normal run, 1=backfill)"
        required: false
        default: "0"
      backfill_limit:
        description: "Backfill limit (trading days). Suggested: 252"
        required: false
        default: "252"
      backfill_end_date:
        description: "Optional end date (YYYY-MM-DD). Leave empty to auto-use latest available."
        required: false
        default: ""
  schedule:
    # Every 9 hours at minute 8 (UTC): 00:08, 09:08, 18:08
    # Asia/Taipei (UTC+8): 08:08, 17:08, 02:08 (next day)
    - cron: "8 */9 * * *"

permissions:
  contents: write

concurrency:
  # daily + dispatch(normal) share the same writer lock
  group: repo-writer-main
  cancel-in-progress: false

jobs:
  update_daily:
    if: github.event_name == 'schedule' || (github.event_name == 'workflow_dispatch' && (github.event.inputs.backfill == '' || github.event.inputs.backfill == '0'))
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          pip install --no-cache-dir requests

      - name: Generate + sanity + commit + push (retry-safe, no-rebase)
        env:
          TZ: Asia/Taipei
        run: |
          set -euo pipefail

          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          data_files=(
            "roll25_cache/roll25.json"
            "roll25_cache/latest_report.json"
            "roll25_cache/stats_latest.json"
          )
          manifest_file="roll25_cache/manifest.json"

          for attempt in 1 2 3; do
            echo "===== Attempt ${attempt} (daily) ====="

            # Always start from latest remote main
            git fetch origin main
            git reset --hard origin/main
            git clean -fd

            echo "Runner time (UTC):    $(date -u '+%Y-%m-%d %H:%M:%S %Z')"
            echo "Runner time (Taipei): $(TZ=Asia/Taipei date '+%Y-%m-%d %H:%M:%S %Z')"

            start_epoch="$(date +%s)"

            # 1) Generate (MUST fail with non-zero on fatal errors)
            python scripts/update_twse_sidecar.py

            # 2) Sanity (must fail if sanity fails)
            python scripts/sanity_twse_roll25.py

            # 3) Required outputs & stale-mtime check (avoid committing stale files)
            missing=0
            for f in "${data_files[@]}"; do
              if [ ! -f "$f" ]; then
                echo "[ERROR] missing required file: $f"
                missing=1
                continue
              fi
              mtime="$(stat -c %Y "$f" || echo 0)"
              if [ "$mtime" -lt "$start_epoch" ]; then
                echo "[ERROR] $f was not updated by this run (stale mtime)"
                missing=1
              fi
            done
            if [ "$missing" -eq 1 ]; then
              echo "[ERROR] required outputs missing or stale; abort."
              exit 1
            fi

            # 4) Fingerprint (audit only)
            for f in "${data_files[@]}"; do
              h="$(sha256sum "$f" | awk '{print $1}')"
              echo "$f  sha256=$h"
            done

            # 5) Commit DATA (first commit)
            git add -A "${data_files[@]}"
            if git diff --cached --quiet; then
              echo "No staged data changes to commit."
              echo "Manifest main URL:"
              echo "https://raw.githubusercontent.com/${GITHUB_REPOSITORY}/refs/heads/main/${manifest_file}"
              exit 0
            fi

            git commit -m "Update TWSE sidecar data (roll25 + latest_report + stats)"
            DATA_SHA="$(git rev-parse HEAD)"
            echo "DATA_SHA=${DATA_SHA}"

            # 6) Generate manifest pinned to DATA_SHA (second commit)
            python scripts/write_twse_manifest.py --data-sha "${DATA_SHA}" --out "${manifest_file}"

            git add -A "${manifest_file}"
            if git diff --cached --quiet; then
              echo "[ERROR] manifest.json did not change after generation (unexpected)."
              exit 1
            fi

            git commit -m "Update TWSE manifest (pinned to ${DATA_SHA})"
            MANIFEST_SHA="$(git rev-parse HEAD)"
            echo "MANIFEST_SHA=${MANIFEST_SHA}"

            echo "Snapshot URLs:"
            echo "  DATA (immutable):     https://raw.githubusercontent.com/${GITHUB_REPOSITORY}/${DATA_SHA}/roll25_cache/latest_report.json"
            echo "  MANIFEST (immutable): https://raw.githubusercontent.com/${GITHUB_REPOSITORY}/${MANIFEST_SHA}/roll25_cache/manifest.json"
            echo "  MANIFEST (main):      https://raw.githubusercontent.com/${GITHUB_REPOSITORY}/refs/heads/main/roll25_cache/manifest.json"

            # 7) Push. If rejected, retry from latest origin/main.
            if git push origin HEAD:main; then
              echo "Push succeeded."
              exit 0
            fi

            echo "Push failed (likely non-fast-forward). Backoff then retry."
            if [ "$attempt" -eq 1 ]; then sleep 2; fi
            if [ "$attempt" -eq 2 ]; then sleep 4; fi
            if [ "$attempt" -eq 3 ]; then sleep 8; fi
          done

          echo "Push failed after 3 attempts."
          exit 1

  backfill:
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.backfill != '' && github.event.inputs.backfill != '0'
    runs-on: ubuntu-latest
    timeout-minutes: 60

    concurrency:
      # backfill uses its own writer lock to avoid fighting with daily schedule
      group: repo-writer-backfill
      cancel-in-progress: false

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          pip install --no-cache-dir requests

      - name: Backfill + sanity + commit + push (retry-safe, no-rebase)
        env:
          TZ: Asia/Taipei
          # These env vars assume your update_twse_sidecar.py reads them.
          # If not, they are harmless.
          BACKFILL_LIMIT: ${{ github.event.inputs.backfill_limit }}
          BACKFILL_END_DATE: ${{ github.event.inputs.backfill_end_date }}
        run: |
          set -euo pipefail

          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          data_files=(
            "roll25_cache/roll25.json"
            "roll25_cache/latest_report.json"
            "roll25_cache/stats_latest.json"
          )
          manifest_file="roll25_cache/manifest.json"

          for attempt in 1 2 3; do
            echo "===== Attempt ${attempt} (backfill) ====="

            git fetch origin main
            git reset --hard origin/main
            git clean -fd

            echo "Runner time (UTC):    $(date -u '+%Y-%m-%d %H:%M:%S %Z')"
            echo "Runner time (Taipei): $(TZ=Asia/Taipei date '+%Y-%m-%d %H:%M:%S %Z')"
            echo "Backfill settings: BACKFILL_LIMIT=${BACKFILL_LIMIT} BACKFILL_END_DATE=${BACKFILL_END_DATE}"

            start_epoch="$(date +%s)"

            # 1) Generate (backfill mode depends on script implementation)
            python scripts/update_twse_sidecar.py

            # 2) Sanity
            python scripts/sanity_twse_roll25.py

            # 3) Required outputs & stale-mtime check
            missing=0
            for f in "${data_files[@]}"; do
              if [ ! -f "$f" ]; then
                echo "[ERROR] missing required file: $f"
                missing=1
                continue
              fi
              mtime="$(stat -c %Y "$f" || echo 0)"
              if [ "$mtime" -lt "$start_epoch" ]; then
                echo "[ERROR] $f was not updated by this run (stale mtime)"
                missing=1
              fi
            done
            if [ "$missing" -eq 1 ]; then
              echo "[ERROR] required outputs missing or stale; abort."
              exit 1
            fi

            # 4) Fingerprint (audit only)
            for f in "${data_files[@]}"; do
              h="$(sha256sum "$f" | awk '{print $1}')"
              echo "$f  sha256=$h"
            done

            # 5) Commit DATA
            git add -A "${data_files[@]}"
            if git diff --cached --quiet; then
              echo "No staged data changes to commit."
              echo "Manifest main URL:"
              echo "https://raw.githubusercontent.com/${GITHUB_REPOSITORY}/refs/heads/main/${manifest_file}"
              exit 0
            fi

            git commit -m "Backfill TWSE sidecar data (roll25 + latest_report + stats)"
            DATA_SHA="$(git rev-parse HEAD)"
            echo "DATA_SHA=${DATA_SHA}"

            # 6) Generate manifest pinned to DATA_SHA
            python scripts/write_twse_manifest.py --data-sha "${DATA_SHA}" --out "${manifest_file}"

            git add -A "${manifest_file}"
            if git diff --cached --quiet; then
              echo "[ERROR] manifest.json did not change after generation (unexpected)."
              exit 1
            fi

            git commit -m "Update TWSE manifest (pinned to ${DATA_SHA})"
            MANIFEST_SHA="$(git rev-parse HEAD)"
            echo "MANIFEST_SHA=${MANIFEST_SHA}"

            echo "Snapshot URLs:"
            echo "  DATA (immutable):     https://raw.githubusercontent.com/${GITHUB_REPOSITORY}/${DATA_SHA}/roll25_cache/latest_report.json"
            echo "  MANIFEST (immutable): https://raw.githubusercontent.com/${GITHUB_REPOSITORY}/${MANIFEST_SHA}/roll25_cache/manifest.json"
            echo "  MANIFEST (main):      https://raw.githubusercontent.com/${GITHUB_REPOSITORY}/refs/heads/main/roll25_cache/manifest.json"

            if git push origin HEAD:main; then
              echo "Push succeeded."
              exit 0
            fi

            echo "Push failed (likely non-fast-forward). Backoff then retry."
            if [ "$attempt" -eq 1 ]; then sleep 2; fi
            if [ "$attempt" -eq 2 ]; then sleep 4; fi
            if [ "$attempt" -eq 3 ]; then sleep 8; fi
          done

          echo "Push failed after 3 attempts."
          exit 1