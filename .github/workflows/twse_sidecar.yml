name: Update TWSE sidecar (roll25 + latest_report + manifest)

on:
  workflow_dispatch: {}
  schedule:
    # Run at minute 8, every 9 hours (UTC): 00:08, 09:08, 18:08
    # Asia/Taipei (UTC+8): 08:08, 17:08, 02:08 (next day)
    - cron: "8 */9 * * *"

permissions:
  contents: write

concurrency:
  group: repo-writer-main
  cancel-in-progress: false

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          pip install --no-cache-dir requests

      - name: Generate + sanity + commit + push (retry-safe, no-rebase)
        env:
          TZ: Asia/Taipei
        run: |
          set -euo pipefail

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          for attempt in 1 2 3; do
            echo "===== Attempt ${attempt} ====="

            # Always start from latest remote main
            git fetch origin main
            git reset --hard origin/main
            git clean -fd

            echo "Runner time (UTC):    $(date -u '+%Y-%m-%d %H:%M:%S %Z')"
            echo "Runner time (Taipei): $(TZ=Asia/Taipei date '+%Y-%m-%d %H:%M:%S %Z')"

            # 1) Generate
            python scripts/update_twse_sidecar.py

            # 2) Sanity
            python scripts/sanity_twse_roll25.py

            # 3) Fingerprint (audit only)
            files=(
              "roll25_cache/roll25.json"
              "roll25_cache/latest_report.json"
              "roll25_cache/manifest.json"
            )
            for f in "${files[@]}"; do
              if [ -f "$f" ]; then
                h="$(sha256sum "$f" | awk '{print $1}')"
                echo "$f  sha256=$h"
              else
                echo "$f  sha256=MISSING"
              fi
            done

            # 4) Commit if changed
            git add -A roll25_cache/roll25.json roll25_cache/latest_report.json roll25_cache/manifest.json || true
            if git diff --cached --quiet; then
              echo "No staged changes to commit."
              exit 0
            fi

            git commit -m "Update TWSE sidecar cache" || {
              echo "Nothing to commit after staging."
              exit 0
            }

            # 5) Push (no merge/rebase). If rejected, retry from latest origin/main.
            if git push origin HEAD:main; then
              echo "Push succeeded."
              exit 0
            fi

            echo "Push failed (likely non-fast-forward)."
            if [ "$attempt" -eq 1 ]; then sleep 2; fi
            if [ "$attempt" -eq 2 ]; then sleep 4; fi
            if [ "$attempt" -eq 3 ]; then sleep 8; fi
          done

          echo "Push failed after 3 attempts."
          exit 1