name: Update FRED cache

on:
  workflow_dispatch: {}
  schedule:
    # Every 6 hours at minute 7 (UTC): 00:07, 06:07, 12:07, 18:07
    # Asia/Taipei: 08:07, 14:07, 20:07, 02:07
    - cron: "7 */6 * * *"

permissions:
  contents: write

concurrency:
  # ⚠️ 請確保「所有會 push main 的 workflow」都用同一個 group
  group: repo-writer-main
  cancel-in-progress: true

jobs:
  update:
    runs-on: ubuntu-latest
    env:
      TIMEZONE: Asia/Taipei

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          python -m pip install requests

      # ✅ 一步完成：reset到遠端最新 → 產檔 → 連續commit(3個) → 單次push
      # 若 push 遇到 fetch-first（被插隊），就整段重跑（最多3次，2/4/8秒）
      - name: Build + commit + push (single push with retry)
        env:
          FRED_API_KEY: ${{ secrets.FRED_API_KEY }}
          REPO: ${{ github.repository }}
        run: |
          set -euo pipefail

          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          backoff() {
            case "$1" in
              1) sleep 2 ;;
              2) sleep 4 ;;
              3) sleep 8 ;;
            esac
          }

          for attempt in 1 2 3; do
            echo "::group::attempt_${attempt}"

            # 1) 先把工作目錄同步到遠端 main 最新狀態（避免本地基底落後）
            git fetch origin main
            git reset --hard origin/main
            git clean -fdx

            # 2) 產出資料檔（latest/history/dq_state/manifest 初版）
            python scripts/fred_cache.py

            # 3) commit data（但先判斷是否真的有變更）
            git add -A cache
            if git diff --cached --quiet; then
              echo "No changes. Stop."
              echo "::endgroup::"
              exit 0
            fi

            git commit -m "Update cache (latest + history)"
            DATA_SHA="$(git rev-parse HEAD)"

            # 4) Patch manifest：寫入 pinned data URLs（manifest_json 先暫指 main）
            python - << 'PY'
            import json, os
            from pathlib import Path

            repo = os.environ["REPO"]
            data_sha = os.environ["DATA_SHA"]

            p = Path("cache/manifest.json")
            obj = json.loads(p.read_text(encoding="utf-8")) if p.exists() else {}

            obj.setdefault("generated_at_utc", None)
            obj.setdefault("as_of_ts", None)

            obj["data_commit_sha"] = data_sha
            base = f"https://raw.githubusercontent.com/{repo}/{data_sha}/cache"

            obj["pinned"] = {
              "latest_json": f"{base}/latest.json",
              "history_json": f"{base}/history.json",
              "latest_csv":  f"{base}/latest.csv",
              "manifest_json": f"https://raw.githubusercontent.com/{repo}/refs/heads/main/cache/manifest.json",
            }

            p.write_text(json.dumps(obj, ensure_ascii=False, separators=(",", ":")), encoding="utf-8")
            PY

            git add cache/manifest.json
            git commit -m "Update manifest (pinned data urls)"
            MANIFEST_SHA="$(git rev-parse HEAD)"

            # 5) Self-pin：把 pinned.manifest_json 改成指向 v1 sha 的 pinned manifest，再 commit 一次（v2）
            python - << 'PY'
            import json, os
            from pathlib import Path

            repo = os.environ["REPO"]
            sha1 = os.environ["MANIFEST_SHA"]

            p = Path("cache/manifest.json")
            obj = json.loads(p.read_text(encoding="utf-8")) if p.exists() else {}
            obj.setdefault("pinned", {})

            obj["pinned"]["manifest_json"] = f"https://raw.githubusercontent.com/{repo}/{sha1}/cache/manifest.json"
            obj["manifest_commit_sha_v1"] = sha1

            p.write_text(json.dumps(obj, ensure_ascii=False, separators=(",", ":")), encoding="utf-8")
            PY

            git add cache/manifest.json
            git commit -m "Update manifest (pin manifest url)"
            MANIFEST2_SHA="$(git rev-parse HEAD)"

            # 6) 單次 push（把剛剛連續的 3 commits 一次推上去）
            if git push origin HEAD:main; then
              echo "Push OK."

              # 給後續 log / 你人工查核用
              echo "DATA_SHA=$DATA_SHA" >> "$GITHUB_ENV"
              echo "MANIFEST_SHA=$MANIFEST_SHA" >> "$GITHUB_ENV"
              echo "MANIFEST2_SHA=$MANIFEST2_SHA" >> "$GITHUB_ENV"

              python - << 'PY'
              import json, os
              from datetime import datetime, timezone

              repo = os.environ["REPO"]
              data_sha = os.environ["DATA_SHA"]
              sha1 = os.environ["MANIFEST_SHA"]
              sha2 = os.environ["MANIFEST2_SHA"]

              out = {
                "generated_at_utc": datetime.now(timezone.utc).replace(microsecond=0).isoformat(),
                "data_commit_sha": data_sha,
                "manifest_commit_sha_v1": sha1,
                "manifest_commit_sha_v2": sha2,
                "pinned": {
                  "latest_json": f"https://raw.githubusercontent.com/{repo}/{data_sha}/cache/latest.json",
                  "history_json": f"https://raw.githubusercontent.com/{repo}/{data_sha}/cache/history.json",
                  "latest_csv":  f"https://raw.githubusercontent.com/{repo}/{data_sha}/cache/latest.csv",
                  "manifest_json": f"https://raw.githubusercontent.com/{repo}/{sha2}/cache/manifest.json",
                }
              }
              print(json.dumps(out, ensure_ascii=False, separators=(",", ":")))
              PY

              echo "::endgroup::"
              break
            fi

            echo "Push rejected (likely remote advanced). Will retry..."
            echo "::endgroup::"
            backoff "$attempt"

            if [ "$attempt" -eq 3 ]; then
              echo "ERROR: push failed after retries."
              exit 1
            fi
          done

      # 7) （保留你的 sanity check）
      - name: Sanity check (history daily coverage)
        run: |
          set -euo pipefail
          python - << 'PY'
          import json
          from pathlib import Path
          from collections import Counter

          h = json.loads(Path("cache/history.json").read_text(encoding="utf-8"))

          days = sorted({r.get("as_of_ts","")[:10] for r in h if r.get("as_of_ts")})
          c = Counter(r.get("as_of_ts","")[:10] for r in h if r.get("as_of_ts"))

          keys = set((r.get("as_of_ts","")[:10], r.get("series_id","")) for r in h)
          dedupe_ok = (len(keys) == len(h))

          print("history_records =", len(h))
          print("days_in_history =", days)
          print("rows_per_day    =", dict(c))
          print("dedupe_ok       =", dedupe_ok)
          print("cap_records     =", 720, "cap_ok =", len(h) <= 720)
          PY