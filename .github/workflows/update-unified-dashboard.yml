name: Update Unified Dashboard (merge+render)

on:
  workflow_dispatch: {}
  schedule:
    # 23:30 Asia/Taipei = 15:30 UTC
    - cron: "30 15 * * *"

permissions:
  contents: write

concurrency:
  group: repo-writer-main
  cancel-in-progress: false

jobs:
  unified:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Ensure output dir
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p unified_dashboard

      - name: Verify required inputs exist
        shell: bash
        run: |
          set -euo pipefail
          req=(
            "dashboard/dashboard_latest.json"
            "dashboard_fred_cache/dashboard_latest.json"
            "taiwan_margin_cache/latest.json"
            "roll25_cache/latest_report.json"
            "fx_cache/latest.json"
            "fx_cache/history.json"
            "scripts/build_unified_dashboard_latest.py"
            "scripts/render_unified_report_md.py"
          )
          missing=0
          for f in "${req[@]}"; do
            if [[ ! -f "$f" ]]; then
              echo "MISSING: $f"
              missing=1
            else
              echo "OK: $f"
            fi
          done
          if [[ "$missing" -ne 0 ]]; then
            echo "Required files missing. Stop."
            exit 1
          fi

      - name: Build unified_dashboard/latest.json
        shell: bash
        env:
          ROLL25_VOL_N: "10"
          ROLL25_DD_N: "10"
        run: |
          set -euo pipefail
          python scripts/build_unified_dashboard_latest.py \
            --market-in "dashboard/dashboard_latest.json" \
            --fred-in "dashboard_fred_cache/dashboard_latest.json" \
            --twmargin-in "taiwan_margin_cache/latest.json" \
            --roll25-in "roll25_cache/latest_report.json" \
            --fx-in "fx_cache/latest.json" \
            --fx-history "fx_cache/history.json" \
            --out "unified_dashboard/latest.json"

          test -s unified_dashboard/latest.json
          echo "OK: unified_dashboard/latest.json size=$(wc -c < unified_dashboard/latest.json)"

      - name: Render unified_dashboard/report.md
        shell: bash
        run: |
          set -euo pipefail

          in_path="unified_dashboard/latest.json"
          out_path="unified_dashboard/report.md"

          # Pre-guard: root report.md should NOT exist before render.
          # If it exists, fail fast (audit-first). Do not silently delete.
          if [[ -f "report.md" ]]; then
            echo "ERROR: root report.md exists BEFORE render. This indicates stale/duplicate output."
            echo "       Please remove it in repo or fix upstream steps. Refusing to proceed."
            ls -la report.md || true
            exit 1
          fi

          # Render into the unified_dashboard folder (NOT repo root)
          python scripts/render_unified_report_md.py \
            --in "$in_path" \
            --out "$out_path"

          # Post-guard: output must exist and be non-empty.
          test -s "$out_path"
          echo "OK: $out_path size=$(wc -c < "$out_path")"

          # Post-guard: renderer must NOT create root report.md.
          if [[ -f "report.md" ]]; then
            echo "ERROR: root report.md was created AFTER render. Renderer/output path may be broken."
            echo "       Refusing to continue to avoid committing ambiguous outputs."
            ls -la report.md || true
            exit 1
          fi

      - name: Show brief outputs (for logs)
        shell: bash
        run: |
          set -euo pipefail
          echo "---- git status ----"
          git status --porcelain || true

          echo "---- unified_dashboard/latest.json (head 30) ----"
          sed -n '1,30p' unified_dashboard/latest.json || true

          echo "---- unified_dashboard/report.md (head 60) ----"
          sed -n '1,60p' unified_dashboard/report.md || true

          echo "---- unified_dashboard/report.md (tail 15) ----"
          tail -n 15 unified_dashboard/report.md || true

      - name: Commit & push if changed
        shell: bash
        run: |
          set -euo pipefail

          # Fail fast if outputs are ignored
          if git check-ignore -q unified_dashboard/latest.json; then
            echo "ERROR: unified_dashboard/latest.json is ignored by .gitignore"
            exit 1
          fi
          if git check-ignore -q unified_dashboard/report.md; then
            echo "ERROR: unified_dashboard/report.md is ignored by .gitignore"
            exit 1
          fi

          if [[ -z "$(git status --porcelain)" ]]; then
            echo "No changes. Skip commit."
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Only stage intended outputs + any necessary deletions tracked by git.
          git add unified_dashboard/latest.json unified_dashboard/report.md
          git add -u

          # Optional hard-guard: refuse to commit if staged changes include paths outside unified_dashboard/
          staged_paths="$(git diff --cached --name-only || true)"
          bad_paths="$(echo "$staged_paths" | awk 'NF && $0 !~ /^unified_dashboard\// {print $0}')"
          if [[ -n "$bad_paths" ]]; then
            echo "ERROR: Refusing to commit staged changes outside unified_dashboard/:"
            echo "$bad_paths"
            echo "Hint: remove unintended changes or adjust staging rules."
            exit 1
          fi

          git commit -m "Update unified dashboard + report"
          git push